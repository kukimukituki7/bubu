//@version=5
indicator("Boss v5", overlay=true, max_lines_count = 500, max_boxes_count = 500, max_labels_count = 500)

// ---------------------
// ---------------------
// | Chaos dual
// ---------------------
// ---------------------


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ EMAs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ema21  = ta.ema(close, 21)
ema55  = ta.ema(close, 55)
ema100 = ta.ema(close, 100)
ema200 = ta.ema(close, 200)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. Directional Efficiency â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
lengthEff = 20
netMove = math.abs(close - close[lengthEff])
totalMove = 0.0
for i = 0 to lengthEff - 1
    totalMove += math.abs(close[i] - close[i+1])

efficiency = totalMove != 0 ? netMove / totalMove : 0

trendRegime = efficiency > 0.4

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Wick Dominance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
body = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low

wickRatio = body != 0 ? (upperWick + lowerWick) / body : 0

sweepCondition = wickRatio > 2

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Range Persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
atr = ta.atr(14)
largeRange = (high - low) > atr * 1.2
rangePersistence = math.sum(largeRange ? 1 : 0, 5)

impulseCondition = rangePersistence >= 3

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Final Regime Decision â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
isTrend = trendRegime and impulseCondition and not sweepCondition
isSweep = not trendRegime or sweepCondition

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Trend Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
bullStructure = ema21 > ema55 and ema55 > ema100
bearStructure = ema21 < ema55 and ema55 < ema100

trendBuy  = isTrend and bullStructure and close > ema55
trendSell = isTrend and bearStructure and close < ema55

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Mean Reversion Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
mrBuy  = isSweep and close < ema21 and wickRatio > 2
mrSell = isSweep and close > ema21 and wickRatio > 2

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Plot EMAs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
plot(ema21,  color=color.teal,   linewidth=2)
plot(ema55,  color=color.orange, linewidth=2)
plot(ema100, color=color.blue,   linewidth=2)
plot(ema200, color=color.red,    linewidth=2)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Signals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
plotshape(trendBuy,  location=location.belowbar, style=shape.triangleup,   color=color.green, size=size.small)
plotshape(trendSell, location=location.abovebar, style=shape.triangledown, color=color.red,   size=size.small)

plotshape(mrBuy,  location=location.belowbar, style=shape.circle, color=color.lime, size=size.tiny)
plotshape(mrSell, location=location.abovebar, style=shape.circle, color=color.maroon, size=size.tiny)


// ---------------------
// ---------------------
// | BOSS
// ---------------------
// ---------------------

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

ShowSD1    = input(false, "Supply Demand Zone", group = "Supply Demand 1", inline = "Supply Demand 1")
ShowSZ1    = input(false, "Support Zone",       group = "Supply Demand 1", inline = "Supply Demand 1")
ShowRZ1    = input(false, "Resistance Zone",    group = "Supply Demand 1", inline = "Supply Demand 1")

RSI1Length = input.int(7, minval=1, title="RSI 1 Length",                                                                            group="Supply Demand 1")
RSI1OBOSIn = input.string(defval="70 / 30", title="OB / OS", options=["70 / 30", "75 / 25", "80 / 20", "85 / 15", "90 / 10", "95 / 5"], group="Supply Demand 1")
NumberOfConfirmationBarsRSI1 = input(3, title="Confirmation Bars",                                                               group="Supply Demand 1")

RSI1SDColorIn          = input(color.new(color.blue, 85), "Fill Colors - Supply Demand",  group="Supply Demand 1", inline = "Fill 1")
RSI1SupportColorIn     = input(color.new(color.lime, 92), "Support",                      group="Supply Demand 1", inline = "Fill 1")
RSI1ResistanceColorIn  = input(color.new(color.red,  92), "Resistance",                   group="Supply Demand 1", inline = "Fill 1")


RSI1       = ta.rsi(close, RSI1Length)

RSI1OB = RSI1OBOSIn == "70 / 30" ? 70 : 
   RSI1OBOSIn == "75 / 25" ? 75 : RSI1OBOSIn == "80 / 20" ? 80 : 
   RSI1OBOSIn == "90 / 10" ? 90 : RSI1OBOSIn == "95 / 5" ? 95 : 100
RSI1OS = RSI1OBOSIn == "70 / 30" ? 30 : 
   RSI1OBOSIn == "75 / 25" ? 25 : RSI1OBOSIn == "80 / 20" ? 20 : 
   RSI1OBOSIn == "90 / 10" ? 10 : RSI1OBOSIn == "95 / 5" ? 5 : 0



RSI1incrementer_up   = RSI1 > RSI1OB ? 1 : 0
RSI1incrementer_down = RSI1 < RSI1OS ? 1 : 0
RSI1incrementer_both = RSI1 > RSI1OB or RSI1 < RSI1OS ? 1 : 0


RSI1rsx = 0


if RSI1incrementer_both
    RSI1rsx := nz(RSI1rsx[1], 0) + RSI1incrementer_both
    RSI1rsx
else
    RSI1rsx = 0
    RSI1rsx

RSI1rxH = if RSI1rsx >= NumberOfConfirmationBarsRSI1
    RSI1x = high
    RSI1x
RSI1rxL = if RSI1rsx >= NumberOfConfirmationBarsRSI1
    RSI1y = low
    RSI1y

RSI1rH = fixnan(RSI1rxH)
RSI1rL = fixnan(RSI1rxL)


///////////////////////////////////////////////////////


RSI1rsu = 0


if RSI1incrementer_up
    RSI1rsu := nz(RSI1rsu[1], 0) + RSI1incrementer_up
    RSI1rsu
else
    RSI1rsu = 0
    RSI1rsu


RSI1rssH = if RSI1rsu >= NumberOfConfirmationBarsRSI1
    RSI1x = high
    RSI1x


RSI1rssL = if RSI1rsu >= NumberOfConfirmationBarsRSI1
    RSI1y = low
    RSI1y

RSI1ResistanceZoneHigh = fixnan(RSI1rssH)
RSI1ResistanceZoneLow  = fixnan(RSI1rssL)


////////////////////////////////////////////////////////


RSI1rsd = 0


if RSI1incrementer_down
    RSI1rsd := nz(RSI1rsd[1], 0) + RSI1incrementer_down
    RSI1rsd
else
    RSI1rsd = 0
    RSI1rsd

RSI1rsrH = if RSI1rsd >= NumberOfConfirmationBarsRSI1
    RSI1x = high
    RSI1x

RSI1rsrL = if RSI1rsd >= NumberOfConfirmationBarsRSI1
    RSI1y = low
    RSI1y


RSI1SupportZoneHigh = fixnan(RSI1rsrH)
RSI1SupportZoneLow  = fixnan(RSI1rsrL)


////////////////////////////////////////////////////////

RSI1_ResZoneColor = RSI1ResistanceZoneHigh !=  RSI1ResistanceZoneHigh[1] ?  na : RSI1ResistanceColorIn
RSI1_SupZoneColor = RSI1SupportZoneLow     !=  RSI1SupportZoneLow[1]     ?  na : RSI1SupportColorIn

RSI1SDColor       = RSI1rH != RSI1rH[1]?                                    na : RSI1SDColorIn

////////////////////////////////////////////////////////

RSI1RZHigh = plot(ShowRZ1 ? RSI1ResistanceZoneHigh : na, style=plot.style_cross, title="Resistance Zone - 1 - High", color=RSI1_ResZoneColor, transp=1)
RSI1RZLow  = plot(ShowRZ1 ? RSI1ResistanceZoneLow  : na, style=plot.style_cross, title="Resistance Zone - 1 - Low",  transp=100)
fill(RSI1RZHigh, RSI1RZLow, color=RSI1_ResZoneColor, title="Support Zone - 1 - Fill")

RSI1SZHigh = plot(ShowSZ1 ? RSI1SupportZoneHigh    : na, style=plot.style_cross,    title="Support Zone - 1 - High", transp=100)
RSI1SZLow  = plot(ShowSZ1 ? RSI1SupportZoneLow     : na, style=plot.style_cross,    title="Support Zone - 1 - Low",  transp=100)
fill(RSI1SZHigh, RSI1SZLow, color=RSI1_SupZoneColor, title="Support Zone - 1 - Fill")


PlotRSI1rH = plot(ShowSD1 ? RSI1rH : na,  style=plot.style_cross, linewidth=1, title="Supply Demand - 1 - High")
PlotRSI1rL = plot(ShowSD1 ? RSI1rL : na,  style=plot.style_cross, linewidth=1, title="Supply Demand - 1 - Low")
fill(PlotRSI1rH, PlotRSI1rL, color=RSI1SDColor, title="Supply Demand - 1 - Fill")

////////////////////////////////////////////////////////

PriceInRSI1SDZone     = (close <= RSI1rH) and (close >= RSI1rL) and (RSI1rH == RSI1rH[1])
PriceEntersRSI1SDZone = (PriceInRSI1SDZone and not PriceInRSI1SDZone[1])

alertcondition(PriceEntersRSI1SDZone,   title='Alert - Price Enters S/D Zone 1',    message='Price Enters S/D Zone 1 - RSI S/D')


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


ShowSD2    = input(true,  "Supply Demand Zone", group = "Supply Demand 2", inline = "Supply Demand 2")
ShowSZ2    = input(false, "Support Zone",       group = "Supply Demand 2", inline = "Supply Demand 2")
ShowRZ2    = input(false, "Resistance Zone",    group = "Supply Demand 2", inline = "Supply Demand 2")

RSI2Length  = input.int(14, minval=1, title="RSI 2 Length",                                                                            group="Supply Demand 2")
RSI2OBOSIn  = input.string(defval="70 / 30", title="OB / OS", options=["70 / 30", "75 / 25", "80 / 20", "85 / 15", "90 / 10", "95 / 5"], group="Supply Demand 2")
NumberOfConfirmationBarsRSI2 = input(3, title="Confirmation Bars",                                                                group="Supply Demand 2")

RSI2SDColorIn          = input(color.new(color.blue, 85), "Fill Colors - Supply Demand",  group="Supply Demand 2", inline = "Fill 2")
RSI2SupportColorIn     = input(color.new(color.lime, 92), "Support",                      group="Supply Demand 2", inline = "Fill 2")
RSI2ResistanceColorIn  = input(color.new(color.red,  92), "Resistance",                   group="Supply Demand 2", inline = "Fill 2")


RSI2       = ta.rsi(close, RSI2Length)

RSI2OB = RSI2OBOSIn == "70 / 30" ? 70 : 
   RSI2OBOSIn == "75 / 25" ? 75 : RSI2OBOSIn == "80 / 20" ? 80 : 
   RSI2OBOSIn == "90 / 10" ? 90 : RSI2OBOSIn == "95 / 5" ? 95 : 100
RSI2OS = RSI2OBOSIn == "70 / 30" ? 30 : 
   RSI2OBOSIn == "75 / 25" ? 25 : RSI2OBOSIn == "80 / 20" ? 20 : 
   RSI2OBOSIn == "90 / 10" ? 10 : RSI2OBOSIn == "95 / 5" ? 5 : 0


RSI2incrementer_up   = RSI2 > RSI2OB ? 1 : 0
RSI2incrementer_down = RSI2 < RSI2OS ? 1 : 0
RSI2incrementer_both = RSI2 > RSI2OB or RSI2 < RSI2OS ? 1 : 0


RSI2rsx = 0


if RSI2incrementer_both
    RSI2rsx := nz(RSI2rsx[1], 0) + RSI2incrementer_both
    RSI2rsx
else
    RSI2rsx = 0
    RSI2rsx

RSI2rxH = if RSI2rsx >= NumberOfConfirmationBarsRSI2
    RSI2x = high
    RSI2x
RSI2rxL = if RSI2rsx >= NumberOfConfirmationBarsRSI2
    RSI2y = low
    RSI2y

RSI2rH = fixnan(RSI2rxH)
RSI2rL = fixnan(RSI2rxL)



///////////////////////////////////////////////////////


RSI2rsu = 0


if RSI2incrementer_up
    RSI2rsu := nz(RSI2rsu[1], 0) + RSI2incrementer_up
    RSI2rsu
else
    RSI2rsu = 0
    RSI2rsu


RSI2rssH = if RSI2rsu >= NumberOfConfirmationBarsRSI2
    RSI2x = high
    RSI2x


RSI2rssL = if RSI2rsu >= NumberOfConfirmationBarsRSI2
    RSI2y = low
    RSI2y

RSI2ResistanceZoneHigh = fixnan(RSI2rssH)
RSI2ResistanceZoneLow  = fixnan(RSI2rssL)


////////////////////////////////////////////////////////


RSI2rsd = 0


if RSI2incrementer_down
    RSI2rsd := nz(RSI2rsd[1], 0) + RSI2incrementer_down
    RSI2rsd
else
    RSI2rsd = 0
    RSI2rsd

RSI2rsrH = if RSI2rsd >= NumberOfConfirmationBarsRSI2
    RSI2x = high
    RSI2x

RSI2rsrL = if RSI2rsd >= NumberOfConfirmationBarsRSI2
    RSI2y = low
    RSI2y


RSI2SupportZoneHigh = fixnan(RSI2rsrH)
RSI2SupportZoneLow  = fixnan(RSI2rsrL)


////////////////////////////////////////////////////////

RSI2_ResZoneColor = RSI2ResistanceZoneHigh !=  RSI2ResistanceZoneHigh[1] ?  na : RSI2ResistanceColorIn
RSI2_SupZoneColor = RSI2SupportZoneLow     !=  RSI2SupportZoneLow[1]     ?  na : RSI2SupportColorIn

RSI2SDColor       = RSI2rH != RSI2rH[1]?                                    na : RSI2SDColorIn

////////////////////////////////////////////////////////


RSI2RZHigh = plot(ShowRZ2 ? RSI2ResistanceZoneHigh : na, style=plot.style_cross, title="Resistance Zone - 2 - High", transp=100)
RSI2RZLow  = plot(ShowRZ2 ? RSI2ResistanceZoneLow  : na, style=plot.style_cross, title="Resistance Zone - 2 - Low",  transp=100)
fill(RSI2RZHigh, RSI2RZLow, color=RSI2_ResZoneColor, title="Support Zone - 2 - Fill")

RSI2SZHigh = plot(ShowSZ2 ? RSI2SupportZoneHigh    : na, style=plot.style_cross,    title="Support Zone - 2 - High", transp=100)
RSI2SZLow  = plot(ShowSZ2 ? RSI2SupportZoneLow     : na, style=plot.style_cross,    title="Support Zone - 2 - Low",  transp=100)
fill(RSI2SZHigh, RSI2SZLow, color=RSI2_SupZoneColor, title="Support Zone - 2 - Fill")


PlotRSI2rH = plot(ShowSD2 ? RSI2rH : na,  style=plot.style_cross, linewidth=1, title="Supply Demand - 2 - High")
PlotRSI2rL = plot(ShowSD2 ? RSI2rL : na,  style=plot.style_cross, linewidth=1, title="Supply Demand - 2 - Low")
fill(PlotRSI2rH, PlotRSI2rL, color=RSI2SDColor, title="Supply Demand - 2 - Fill")

////////////////////////////////////////////////////////

PriceInRSI2SDZone     = (close <= RSI2rH) and (close >= RSI2rL) and (RSI2rH == RSI2rH[1])
PriceEntersRSI2SDZone = (PriceInRSI2SDZone and not PriceInRSI2SDZone[1])

alertcondition(PriceEntersRSI2SDZone,   title='Alert - Price Enters S/D Zone 2',    message='Price Enters S/D Zone 2 - RSI S/D')


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


ShowSD3    = input(false,  "Supply Demand Zone", group = "Supply Demand 3", inline = "Supply Demand 3")
ShowSZ3    = input(false, "Support Zone",       group = "Supply Demand 3", inline = "Supply Demand 3")
ShowRZ3    = input(false, "Resistance Zone",    group = "Supply Demand 3", inline = "Supply Demand 3")

RSI3Length  = input.int(21,  minval=1, title="RSI 3 Length",                                                                          group="Supply Demand 3")
RSI3OBOSIn  = input.string(defval="70 / 30", title="OB / OS", options=["70 / 30", "75 / 25", "80 / 20", "85 / 15", "90 / 10", "95 / 5"], group="Supply Demand 3")
NumberOfConfirmationBarsRSI3 = input(3, title="Confirmation Bars",                                                                group="Supply Demand 3")

RSI3SDColorIn          = input(color.new(color.blue, 85), "Fill Colors - Supply Demand", group="Supply Demand 3", inline = "Fill 3")
RSI3SupportColorIn     = input(color.new(color.lime, 92), "Support",                      group="Supply Demand 3", inline = "Fill 3")
RSI3ResistanceColorIn  = input(color.new(color.red,  92), "Resistance",                   group="Supply Demand 3", inline = "Fill 3")


RSI3       = ta.rsi(close, RSI3Length)

RSI3OB = RSI3OBOSIn == "70 / 30" ? 70 : 
   RSI3OBOSIn == "75 / 25" ? 75 : RSI3OBOSIn == "80 / 20" ? 80 : 
   RSI3OBOSIn == "90 / 10" ? 90 : RSI3OBOSIn == "95 / 5" ? 95 : 100
RSI3OS = RSI3OBOSIn == "70 / 30" ? 30 : 
   RSI3OBOSIn == "75 / 25" ? 25 : RSI3OBOSIn == "80 / 20" ? 20 : 
   RSI3OBOSIn == "90 / 10" ? 10 : RSI3OBOSIn == "95 / 5" ? 5 : 0


RSI3incrementer_up   = RSI3 > RSI3OB ? 1 : 0
RSI3incrementer_down = RSI3 < RSI3OS ? 1 : 0
RSI3incrementer_both = RSI3 > RSI3OB or RSI3 < RSI3OS ? 1 : 0


RSI3rsx = 0


if RSI3incrementer_both
    RSI3rsx := nz(RSI3rsx[1], 0) + RSI3incrementer_both
    RSI3rsx
else
    RSI3rsx = 0
    RSI3rsx

RSI3rxH = if RSI3rsx >= NumberOfConfirmationBarsRSI3
    RSI3x = high
    RSI3x
RSI3rxL = if RSI3rsx >= NumberOfConfirmationBarsRSI3
    RSI3y = low
    RSI3y

RSI3rH = fixnan(RSI3rxH)
RSI3rL = fixnan(RSI3rxL)



///////////////////////////////////////////////////////


RSI3rsu = 0


if RSI3incrementer_up
    RSI3rsu := nz(RSI3rsu[1], 0) + RSI3incrementer_up
    RSI3rsu
else
    RSI3rsu = 0
    RSI3rsu


RSI3rssH = if RSI3rsu >= NumberOfConfirmationBarsRSI3
    RSI3x = high
    RSI3x


RSI3rssL = if RSI3rsu >= NumberOfConfirmationBarsRSI3
    RSI3y = low
    RSI3y

RSI3ResistanceZoneHigh = fixnan(RSI3rssH)
RSI3ResistanceZoneLow  = fixnan(RSI3rssL)


////////////////////////////////////////////////////////


RSI3rsd = 0


if RSI3incrementer_down
    RSI3rsd := nz(RSI3rsd[1], 0) + RSI3incrementer_down
    RSI3rsd
else
    RSI3rsd = 0
    RSI3rsd

RSI3rsrH = if RSI3rsd >= NumberOfConfirmationBarsRSI3
    RSI3x = high
    RSI3x

RSI3rsrL = if RSI3rsd >= NumberOfConfirmationBarsRSI3
    RSI3y = low
    RSI3y


RSI3SupportZoneHigh = fixnan(RSI3rsrH)
RSI3SupportZoneLow  = fixnan(RSI3rsrL)


////////////////////////////////////////////////////////

RSI3_ResZoneColor = RSI3ResistanceZoneHigh !=  RSI3ResistanceZoneHigh[1] ?  na : RSI3ResistanceColorIn
RSI3_SupZoneColor = RSI3SupportZoneLow     !=  RSI3SupportZoneLow[1]     ?  na : RSI3SupportColorIn

RSI3SDColor       = RSI3rH != RSI3rH[1]?                                    na : RSI3SDColorIn

////////////////////////////////////////////////////////


RSI3RZHigh = plot(ShowRZ3 ? RSI3ResistanceZoneHigh : na, style=plot.style_cross, title="Resistance Zone - 3 - High", transp=100)
RSI3RZLow  = plot(ShowRZ3 ? RSI3ResistanceZoneLow  : na, style=plot.style_cross, title="Resistance Zone - 3 - Low",  transp=100)
fill(RSI3RZHigh, RSI3RZLow, color=RSI3_ResZoneColor, title="Support Zone - 3 - Fill")

RSI3SZHigh = plot(ShowSZ3 ? RSI3SupportZoneHigh    : na, style=plot.style_cross,    title="Support Zone - 3 - High", transp=100)
RSI3SZLow  = plot(ShowSZ3 ? RSI3SupportZoneLow     : na, style=plot.style_cross,    title="Support Zone - 3 - Low",  transp=100)
fill(RSI3SZHigh, RSI3SZLow, color=RSI3_SupZoneColor, title="Support Zone - 3 - Fill")


PlotRSI3rH = plot(ShowSD3 ? RSI3rH : na,  style=plot.style_cross, linewidth=1, title="Supply Demand - 3 - High")
PlotRSI3rL = plot(ShowSD3 ? RSI3rL : na,  style=plot.style_cross, linewidth=1, title="Supply Demand - 3 - Low")
fill(PlotRSI3rH, PlotRSI3rL, color=RSI3SDColor, title="Supply Demand - 3 - Fill")

////////////////////////////////////////////////////////

PriceInRSI3SDZone     = (close <= RSI3rH) and (close >= RSI3rL) and (RSI3rH == RSI3rH[1])
PriceEntersRSI3SDZone = (PriceInRSI3SDZone and not PriceInRSI3SDZone[1])

alertcondition(PriceEntersRSI3SDZone,   title='Alert - Price Enters S/D Zone 3',    message='Price Enters S/D Zone 3 - RSI S/D')


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


ShowSD4    = input(false,  "Supply Demand Zone", group = "Supply Demand 4", inline = "Supply Demand 4")
ShowSZ4    = input(false, "Support Zone",       group = "Supply Demand 4", inline = "Supply Demand 4")
ShowRZ4    = input(false, "Resistance Zone",    group = "Supply Demand 4", inline = "Supply Demand 4")

RSI4Length  = input.int(28,  minval=1, title="RSI 4 Length",                                                                          group="Supply Demand 4")
RSI4OBOSIn  = input.string(defval="70 / 30", title="OB / OS", options=["70 / 30", "75 / 25", "80 / 20", "85 / 15", "90 / 10", "95 / 5"], group="Supply Demand 4")
NumberOfConfirmationBarsRSI4 = input(3, title="Confirmation Bars",                                                                group="Supply Demand 4")

RSI4SDColorIn          = input(color.new(color.blue, 85), "Fill Colors - Supply Demand", group="Supply Demand 4", inline = "Fill 4")
RSI4SupportColorIn     = input(color.new(color.lime, 92), "Support",                    group="Supply Demand 4", inline = "Fill 4")
RSI4ResistanceColorIn  = input(color.new(color.red,  92), "Resistance",                 group="Supply Demand 4", inline = "Fill 4")


RSI4       = ta.rsi(close, RSI4Length)

RSI4OB = RSI4OBOSIn == "70 / 30" ? 70 : 
   RSI4OBOSIn == "75 / 25" ? 75 : RSI4OBOSIn == "80 / 20" ? 80 : 
   RSI4OBOSIn == "90 / 10" ? 90 : RSI4OBOSIn == "95 / 5" ? 95 : 100
RSI4OS = RSI4OBOSIn == "70 / 30" ? 30 : 
   RSI4OBOSIn == "75 / 25" ? 25 : RSI4OBOSIn == "80 / 20" ? 20 : 
   RSI4OBOSIn == "90 / 10" ? 10 : RSI4OBOSIn == "95 / 5" ? 5 : 0


RSI4incrementer_up   = RSI4 > RSI4OB ? 1 : 0
RSI4incrementer_down = RSI4 < RSI4OS ? 1 : 0
RSI4incrementer_both = RSI4 > RSI4OB or RSI4 < RSI4OS ? 1 : 0


RSI4rsx = 0


if RSI4incrementer_both
    RSI4rsx := nz(RSI4rsx[1], 0) + RSI4incrementer_both
    RSI4rsx
else
    RSI4rsx = 0
    RSI4rsx

RSI4rxH = if RSI4rsx >= NumberOfConfirmationBarsRSI4
    RSI4x = high
    RSI4x
RSI4rxL = if RSI4rsx >= NumberOfConfirmationBarsRSI4
    RSI4y = low
    RSI4y

RSI4rH = fixnan(RSI4rxH)
RSI4rL = fixnan(RSI4rxL)



///////////////////////////////////////////////////////


RSI4rsu = 0


if RSI4incrementer_up
    RSI4rsu := nz(RSI4rsu[1], 0) + RSI4incrementer_up
    RSI4rsu
else
    RSI4rsu = 0
    RSI4rsu


RSI4rssH = if RSI4rsu >= NumberOfConfirmationBarsRSI4
    RSI4x = high
    RSI4x


RSI4rssL = if RSI4rsu >= NumberOfConfirmationBarsRSI4
    RSI4y = low
    RSI4y

RSI4ResistanceZoneHigh = fixnan(RSI4rssH)
RSI4ResistanceZoneLow  = fixnan(RSI4rssL)


////////////////////////////////////////////////////////


RSI4rsd = 0


if RSI4incrementer_down
    RSI4rsd := nz(RSI4rsd[1], 0) + RSI4incrementer_down
    RSI4rsd
else
    RSI4rsd = 0
    RSI4rsd

RSI4rsrH = if RSI4rsd >= NumberOfConfirmationBarsRSI4
    RSI4x = high
    RSI4x

RSI4rsrL = if RSI4rsd >= NumberOfConfirmationBarsRSI4
    RSI4y = low
    RSI4y


RSI4SupportZoneHigh = fixnan(RSI4rsrH)
RSI4SupportZoneLow  = fixnan(RSI4rsrL)


////////////////////////////////////////////////////////

RSI4_ResZoneColor = RSI4ResistanceZoneHigh !=  RSI4ResistanceZoneHigh[1] ?  na : RSI4ResistanceColorIn
RSI4_SupZoneColor = RSI4SupportZoneLow     !=  RSI4SupportZoneLow[1]     ?  na : RSI4SupportColorIn

RSI4SDColor       = RSI4rH != RSI4rH[1]?                                    na : RSI4SDColorIn

////////////////////////////////////////////////////////

RSI4RZHigh = plot(ShowRZ4 ? RSI4ResistanceZoneHigh : na, style=plot.style_cross, title="Resistance Zone - 4 - High", transp=100)
RSI4RZLow  = plot(ShowRZ4 ? RSI4ResistanceZoneLow  : na, style=plot.style_cross, title="Resistance Zone - 4 - Low",  transp=100)
fill(RSI4RZHigh, RSI4RZLow, color=RSI4_ResZoneColor, title="Support Zone - 4 - Fill")

RSI4SZHigh = plot(ShowSZ4 ? RSI4SupportZoneHigh    : na, style=plot.style_cross,    title="Support Zone - 4 - High", transp=100)
RSI4SZLow  = plot(ShowSZ4 ? RSI4SupportZoneLow     : na, style=plot.style_cross,    title="Support Zone - 4 - Low",  transp=100)
fill(RSI4SZHigh, RSI4SZLow, color=RSI4_SupZoneColor, title="Support Zone - 4 - Fill")


PlotRSI4rH = plot(ShowSD4 ? RSI4rH : na,  style=plot.style_cross, linewidth=1, title="Supply Demand - 4 - High")
PlotRSI4rL = plot(ShowSD4 ? RSI4rL : na,  style=plot.style_cross, linewidth=1, title="Supply Demand - 4 - Low")
fill(PlotRSI4rH, PlotRSI4rL, color=RSI4SDColor, title="Supply Demand - 4 - Fill")

////////////////////////////////////////////////////////

PriceInRSI4SDZone     = (close <= RSI4rH) and (close >= RSI4rL) and (RSI4rH == RSI4rH[1])
PriceEntersRSI4SDZone = (PriceInRSI4SDZone and not PriceInRSI4SDZone[1])

alertcondition(PriceEntersRSI4SDZone,   title='Alert - Price Enters S/D Zone 4',    message='Price Enters S/D Zone 4 - RSI S/D')


alertcondition(PriceEntersRSI1SDZone or PriceEntersRSI2SDZone or PriceEntersRSI3SDZone or PriceEntersRSI4SDZone,   title='Alert - Price Enters Any S/D Zone',    message='Price Enters Any S/D Zone - RSI S/D')



// RSI Settings for user
rsiSource = input(title="RSI Source", defval=close)
rsiLength = input(title="RSI Length",  defval=7)
rsiOverbought = input.int(title="RSI Overbought", defval=70, minval=51, maxval=100)
rsiOvesold = input.int(title="RSI Oversold",  defval=30, minval=1, maxval=49)

// RSI value based on inbuilt RSI
rsiValue = ta.rsi(rsiSource, rsiLength)

// Get the current state
isOverbought = rsiValue >= rsiOverbought
isOversold = rsiValue <= rsiOvesold

// State of the last extreme 0 for initialization, 1 = overbought, 2 = oversold
var laststate = 0

// Highest and Lowest prices since the last state change
var hh = low
var ll = high

// Labels
var label labelll = na
var label labelhh = na

// Swing lines
var line line_up = na
var line line_down = na

var last_actual_label_hh_price = 0.0
var last_actual_label_ll_price = 0.0


// FUNCTIONS
obLabelText() =>
    if(last_actual_label_hh_price < high)
        "HH"
    else
        "LH"
//plot(last_actual_label_hh_price)
osLabelText() =>
    if(last_actual_label_ll_price < low)
        "HL"
    else
        "LL"

// Create oversold or overbought label
createOverBoughtLabel(isIt) =>
    if(isIt)
        label.new(x=bar_index, y=na ,yloc=yloc.abovebar, style=label.style_label_down, color=color.red, size=size.tiny, text=obLabelText())
    else
        label.new(x=bar_index, y=na ,yloc=yloc.belowbar, style=label.style_label_up, color=color.green, size=size.tiny, text=osLabelText())
       
        
// Move the oversold swing and label
moveOversoldLabel() =>
    label.set_x(labelll, bar_index)
    label.set_y(labelll, low)
    label.set_text(labelll, osLabelText())
    line.set_x1(line_down, bar_index)
    line.set_y1(line_down, low)

moveOverBoughtLabel() =>
    label.set_x(labelhh, bar_index)
    label.set_y(labelhh, high)
    label.set_text(labelhh, obLabelText())
    line.set_x1(line_up, bar_index)
    line.set_y1(line_up, high)

// We go from oversold straight to overbought NEW DRAWINGS CREATED HERE
if(laststate == 2 and isOverbought)
    hh := high
    labelhh := createOverBoughtLabel(true)
    last_actual_label_ll_price := label.get_y(labelll)
    labelll_ts = label.get_x(labelll)
    labelll_price = label.get_y(labelll)
    line_up := line.new(x1=bar_index, y1=high, x2=labelll_ts, y2=labelll_price, width=1)

// We go from overbought straight to oversold  NEW DRAWINGS CREATED HERE
if(laststate == 1 and isOversold)
    ll := low
    labelll := createOverBoughtLabel(false)
    last_actual_label_hh_price := label.get_y(labelhh)
    labelhh_ts = label.get_x(labelhh)
    labelhh_price = label.get_y(labelhh)
    line_down := line.new(x1=bar_index, y1=high, x2=labelhh_ts, y2=labelhh_price, width=1)


// If we are overbought
if(isOverbought)
    if(high >= hh)
        hh := high
        moveOverBoughtLabel()
    laststate := 1
    
// If we are oversold
if(isOversold)
    if(low <= ll)
        ll := low
        moveOversoldLabel()
    laststate := 2
    
    
// If last state was overbought and we are overbought
if(laststate == 1 and isOverbought)
    if(hh <= high)
        hh := high
        moveOverBoughtLabel()
    
//If we are oversold and the last state was oversold, move the drawings to the lowest price
if(laststate == 2 and isOversold)
    if(low <= ll)
        ll := low
        moveOversoldLabel()


// If last state was overbought
if(laststate == 1)
    if(hh <= high)
        hh := high
        moveOverBoughtLabel()
        
// If last stare was oversold
if(laststate == 2)
    if(ll >= low)
        ll := low
        moveOversoldLabel()

//_________________
// CVD CRAP
//_________________
leftBars  = input.int(3, "Left look")
rightBars = input.int(3, "Right look")
topCol    = input.color(color.red)
botCol    = input.color(color.green)
_width    = input.int(2, "Line width")

// ðŸ”§ Cap for active rays
maxRays   = input.int(150, "Max active rays")

ph = ta.pivothigh(high, leftBars, rightBars)
pl = ta.pivotlow(low, leftBars, rightBars)

// Arrays
var line[]  highLines  = array.new_line()
var float[] highPrices = array.new_float()

var line[]  lowLines   = array.new_line()
var float[] lowPrices  = array.new_float()

// â”€â”€â”€â”€â”€ CREATE HIGH RAY â”€â”€â”€â”€â”€
if not na(ph)
    price = ph
    idx   = bar_index - rightBars

    l = line.new(        idx, price,        idx + 1, price,        extend = extend.right,        color  = topCol,        width  = _width    )

    array.push(highLines, l)
    array.push(highPrices, price)

    // cleanup oldest high ray
    if array.size(highLines) > maxRays
        oldLine = array.shift(highLines)
        line.delete(oldLine)
        array.shift(highPrices)

// â”€â”€â”€â”€â”€ CREATE LOW RAY â”€â”€â”€â”€â”€
if not na(pl)
    price = pl
    idx   = bar_index - rightBars

    l = line.new(        idx, price,        idx + 1, price,        extend = extend.right,        color  = botCol,        width  = _width    )

    array.push(lowLines, l)
    array.push(lowPrices, price)

    // cleanup oldest low ray
    if array.size(lowLines) > maxRays
        oldLine = array.shift(lowLines)
        line.delete(oldLine)
        array.shift(lowPrices)

// â”€â”€â”€â”€â”€ CHECK HIGH SWEEPS â”€â”€â”€â”€â”€
if array.size(highLines) > 0
    for i = array.size(highLines) - 1 to 0
        price = array.get(highPrices, i)
        l     = array.get(highLines, i)

        if high > price
            line.set_extend(l, extend.none)
            line.set_x2(l, bar_index)
            line.set_y2(l, price)

            array.remove(highLines, i)
            array.remove(highPrices, i)

// â”€â”€â”€â”€â”€ CHECK LOW SWEEPS â”€â”€â”€â”€â”€
if array.size(lowLines) > 0
    for i = array.size(lowLines) - 1 to 0
        price = array.get(lowPrices, i)
        l     = array.get(lowLines, i)

        if low < price
            line.set_extend(l, extend.none)
            line.set_x2(l, bar_index)
            line.set_y2(l, price)

            array.remove(lowLines, i)
            array.remove(lowPrices, i)

// â”€â”€â”€â”€â”€


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Inputs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
lowerTF  = input.timeframe("1", "Lower Timeframe")
lookback = input.int(10, "Lower TF Lookback", minval=1)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Lower TF Intensity Function
// volume Ã— body Ã— direction
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
f_intensity() =>
    dir = close > open ? 1 : close < open ? -1 : 0
    volume * math.abs(close - open) * dir

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Pull Lower TF Intensity
// Aggregated automatically into HTF bars
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
intensity_ltf = request.security(    syminfo.tickerid,    lowerTF,    f_intensity(),    barmerge.gaps_off,    barmerge.lookahead_off)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Rolling Sum (SAFE METHOD)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
netIntensity =    bar_index >= lookback ?        ta.cum(intensity_ltf) -        ta.cum(intensity_ltf[lookback]) :        na
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Flip-Based Signals (Stable)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buySignal  = netIntensity > 0 and netIntensity[1] <= 0
sellSignal = netIntensity < 0 and netIntensity[1] >= 0

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Plot Signals
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
plotshape(    buySignal,    title="Buy",    style=shape.triangleup,    location=location.belowbar,    color=color.lime,    size=size.small)
plotshape(    sellSignal,    title="Sell",    style=shape.triangledown,    location=location.abovebar,    color=color.red,    size=size.small)


// ___
// CVD
// ___

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// User Inputs
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
lowerTF2       = input.timeframe("1", "Lower TF for CVD")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Daily reset
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Daily / weekly / monthly reset
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tfCVD = input.timeframe("D", "CVD Reset Timeframe")
newDay = ta.change(time(tfCVD)) != 0

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Lower TF data
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
vol_ltf   = request.security(syminfo.tickerid, lowerTF2, volume, barmerge.gaps_off, barmerge.lookahead_off)
close_ltf = request.security(syminfo.tickerid, lowerTF2, close,  barmerge.gaps_off, barmerge.lookahead_off)
open_ltf  = request.security(syminfo.tickerid, lowerTF2, open,   barmerge.gaps_off, barmerge.lookahead_off)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Compute directional CVD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
dir_ltf = close_ltf > open_ltf ? 1 : close_ltf < open_ltf ? -1 : 0
var float cvd_ltf = 0
cvd_ltf := newDay ? 0 : nz(cvd_ltf[1]) + vol_ltf * dir_ltf

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Track anchor for bullish divergence (lowest CVD in session)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var float anchorPrice = na      // price at lowest CVD
var float anchorCVD   = na      // lowest CVD in session
var int   anchorBar   = na      // bar index of anchor

if newDay
    anchorPrice := na
    anchorCVD   := na
    anchorBar   := na

// Update anchor if current CVD is lower than previous lowest
if na(anchorCVD) or cvd_ltf < anchorCVD
    anchorCVD   := cvd_ltf
    anchorPrice := low
    anchorBar   := bar_index

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Bullish divergence detection (strict version)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var float bullDivPrice = na  // price at bar with green circle
var int   bullDivBar   = na  // bar index of green circle

if not na(anchorPrice)
    // Start divergence: first time price below anchor and CVD higher
    if na(bullDivBar) and low < anchorPrice and cvd_ltf > anchorCVD
        bullDivBar   := bar_index
        bullDivPrice := low
    // Move green circle ONLY if new price is LOWER than previous green circle
    if not na(bullDivBar) and low < bullDivPrice and cvd_ltf > anchorCVD
        bullDivBar   := bar_index
        bullDivPrice := low
    // Remove green circle if CVD falls below anchor
    if not na(bullDivBar) and cvd_ltf <= anchorCVD
        bullDivBar   := na
        bullDivPrice := na

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Track anchor for bearish divergence (highest CVD in session)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var float bearAnchorPrice = na      // price at highest CVD
var float bearAnchorCVD   = na      // highest CVD in session
var int   bearAnchorBar   = na      // bar index of anchor

if newDay
    bearAnchorPrice := na
    bearAnchorCVD   := na
    bearAnchorBar   := na

// Update anchor if current CVD is higher than previous highest
if na(bearAnchorCVD) or cvd_ltf > bearAnchorCVD
    bearAnchorCVD   := cvd_ltf
    bearAnchorPrice := high
    bearAnchorBar   := bar_index

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Bearish divergence detection (strict version)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var float bearDivPrice = na  // price at bar with red circle
var int   bearDivBar   = na  // bar index of red circle

if not na(bearAnchorPrice)
    // Start divergence: first time price above anchor and CVD lower
    if na(bearDivBar) and high > bearAnchorPrice and cvd_ltf < bearAnchorCVD
        bearDivBar   := bar_index
        bearDivPrice := high
    // Move red circle ONLY if new price is HIGHER than previous red circle
    if not na(bearDivBar) and high > bearDivPrice and cvd_ltf < bearAnchorCVD
        bearDivBar   := bar_index
        bearDivPrice := high
    // Remove red circle if CVD rises above anchor
    if not na(bearDivBar) and cvd_ltf >= bearAnchorCVD
        bearDivBar   := na
        bearDivPrice := na

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Plotting
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
plot(cvd_ltf, color=color.blue, linewidth=2, title="MTF CVD")
hline(0, "Zero", color=color.gray)

// Plot anchor (absolute lowest CVD)
plotshape(not na(anchorBar) and bar_index == anchorBar ? anchorCVD : na, 
     title="Bull Anchor (Lowest CVD)", style=shape.circle, size=size.tiny, color=color.gray, location=location.belowbar)

// Plot bullish divergence (green circle)
plotshape(not na(bullDivBar) and bar_index == bullDivBar ? cvd_ltf : na, 
     title="Bull Div", style=shape.circle, size=size.tiny, color=color.blue, location=location.belowbar)

// Plot anchor (absolute highest CVD)
plotshape(not na(bearAnchorBar) and bar_index == bearAnchorBar ? bearAnchorCVD : na, 
     title="Bear Anchor (Highest CVD)", style=shape.circle, size=size.tiny, color=color.gray, location=location.abovebar)

// Plot bearish divergence (red circle)
plotshape(not na(bearDivBar) and bar_index == bearDivBar ? cvd_ltf : na, 
     title="Bear Div", style=shape.circle, size=size.tiny, color=color.purple, location=location.abovebar)
