//@version=5
indicator("Mega v2", overlay = true, max_lines_count = 500, max_labels_count = 500, max_bars_back=500, max_boxes_count=500)

// =============================================================================
// STAGE 1 â€” Architecture cleanup
//   â€¢ Replaced `var stupid = 100` magic constant with named INT_LOOKBACK
//   â€¢ Fixed silent 85/15 RSI OB/OS bug (was falling through to 100/0)
//   â€¢ Refactored 4Ã— copy-paste RSI S/D blocks into one reusable function
//   â€¢ Removed 6 dead PVSRA color-transition booleans (redGreen etc.) never used
//   â€¢ Fixed hh/ll backward initialization in swing label tracker
//   â€¢ Removed all commented-out dead fill/plot lines
//   â€¢ Preserved all original functionality â€” same outputs, clean code
// =============================================================================

// =============================================================================
// â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// =============================================================================
INT_LOOKBACK = 100   // was `var stupid = 100`

// =============================================================================
// â”€â”€â”€ NWE (Nadaraya-Watson Envelope) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// =============================================================================
grpNWE = "NWE â€” Nadaraya-Watson Envelope"

h      = input.float(8., 'Bandwidth', minval=0, group=grpNWE)
mult   = input.float(3., 'Multiplier', minval=0, group=grpNWE)
src    = input(close, 'Source', group=grpNWE)
repaint = input(true, 'Repainting Smoothing',
     tooltip='Repainting is an effect where the indicators historical output is subject to change over time. Disabling repainting will cause the indicator to output the endpoints of the calculations',
     group=grpNWE)

upCss = input.color(color.teal, 'Colors', inline='inline1', group=grpNWE)
dnCss = input.color(color.red,  '',        inline='inline1', group=grpNWE)

// Gaussian kernel
gauss(x, h) => math.exp(-(math.pow(x, 2) / (h * h * 2)))

n = bar_index

// â”€â”€ Repainting mode (line array) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var ln = array.new_line(0)

if barstate.isfirst and repaint
    for i = 0 to INT_LOOKBACK
        array.push(ln, line.new(na, na, na, na))

// â”€â”€ Endpoint (non-repainting) mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var coefs = array.new_float(0)
var den   = 0.

if barstate.isfirst and not repaint
    for i = 0 to INT_LOOKBACK
        w = gauss(i, h)
        coefs.push(w)
    den := coefs.sum()

out = 0.
if not repaint
    for i = 0 to INT_LOOKBACK
        out += src[i] * coefs.get(i)
out /= den

mae   = ta.sma(math.abs(src - out), INT_LOOKBACK) * mult
upper = out + mae
lower = out - mae

// â”€â”€ Repainting mode rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
float y2 = na
float y1 = na

nwe = array.new<float>(0)
if barstate.islast and repaint
    sae = 0.
    for i = 0 to math.min(INT_LOOKBACK, n - 1)
        sum  = 0.
        sumw = 0.
        for j = 0 to math.min(INT_LOOKBACK, n - 1)
            w     = gauss(i - j, h)
            sum  += src[j] * w
            sumw += w
        y2   := sum / sumw
        sae  += math.abs(src[i] - y2)
        nwe.push(y2)

    sae := sae / math.min(INT_LOOKBACK, n - 1) * mult
    for i = 0 to math.min(INT_LOOKBACK, n - 1)
        if i % 2
            line.new(n - i + 1, y1 + sae, n - i, nwe.get(i) + sae, color=upCss)
            line.new(n - i + 1, y1 - sae, n - i, nwe.get(i) - sae, color=dnCss)

        if src[i] > nwe.get(i) + sae and src[i + 1] < nwe.get(i) + sae
            label.new(n - i, src[i], 'â–¼', color=color(na), style=label.style_label_down, textcolor=dnCss, textalign=text.align_center)
        if src[i] < nwe.get(i) - sae and src[i + 1] > nwe.get(i) - sae
            label.new(n - i, src[i], 'â–²', color=color(na), style=label.style_label_up,   textcolor=upCss, textalign=text.align_center)

        y1 := nwe.get(i)

// â”€â”€ NWE Plots â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
plot(repaint ? na : upper, 'NWE Upper', upCss)
plot(repaint ? na : lower, 'NWE Lower', dnCss)

plotshape(ta.crossunder(close, lower) ? low  : na, "NWE Crossunder", shape.labelup,   location.absolute, color(na), 0, text='â–²', textcolor=upCss, size=size.tiny)
plotshape(ta.crossover(close,  upper) ? high : na, "NWE Crossover",  shape.labeldown, location.absolute, color(na), 0, text='â–¼', textcolor=dnCss, size=size.tiny)

// â”€â”€ Repainting warning table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var tb = table.new(position.top_right, 1, 1,
     bgcolor      = #1e222d,
     border_color = #373a46,
     border_width = 1,
     frame_color  = #373a46,
     frame_width  = 1)

if repaint
    tb.cell(0, 0, 'Repainting Mode Enabled', text_color=color.white, text_size=size.small)


// =============================================================================
// â”€â”€â”€ PVSRA CANDLE COLORING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// =============================================================================
grpPVSRA = "PVSRA"

bool   overridesym = input.bool(false,             'Override chart symbol?', group=grpPVSRA, inline='pvsra')
string pvsra_sym   = input.symbol('INDEX:BTCUSD',  '',                       group=grpPVSRA, inline='pvsra',
     tooltip='You can use INDEX:BTCUSD or combine feeds like (BINANCE:BTCUSDT+COINBASE:BTCUSD)')

pvsra_security(sresolution, sseries) =>
    request.security(overridesym ? pvsra_sym : syminfo.tickerid, sresolution, sseries[barstate.isrealtime ? 1 : 0], barmerge.gaps_off, barmerge.lookahead_off)

pvsra_volume = overridesym ? pvsra_security('', volume) : volume
pvsra_high   = overridesym ? pvsra_security('', high)   : high
pvsra_low    = overridesym ? pvsra_security('', low)     : low
pvsra_close  = overridesym ? pvsra_security('', close)   : close
pvsra_open   = overridesym ? pvsra_security('', open)    : open

av       = math.sum(pvsra_volume, 10) / 10
value2   = overridesym ? pvsra_volume * (pvsra_high - pvsra_low) : volume * (high - low)
hivalue2 = ta.highest(value2, 10)

iff_1 = pvsra_volume >= av * 1.5 ? 2 : 0
iff_2 = pvsra_volume >= av * 2 or value2 >= hivalue2 ? 1 : iff_1
iff_3 = volume >= av * 1.5 ? 2 : 0
iff_4 = volume >= av * 2 or value2 >= hivalue2 ? 1 : iff_3
va     = overridesym ? iff_2 : iff_4

isBull = overridesym ? pvsra_close > pvsra_open : close > open

CUColor = color.lime        // Climax Up
CDColor = color.red         // Climax Down
AUColor = color.rgb(33, 170, 255)  // Above-avg Up
ADColor = color.fuchsia     // Above-avg Down
NUColor = #9b9b9b
NDColor = #414141

pvsra_bull_color = va == 1 ? CUColor : va == 2 ? AUColor : NUColor
pvsra_bear_color = va == 1 ? CDColor : va == 2 ? ADColor : NDColor
candleColor      = isBull ? pvsra_bull_color : pvsra_bear_color

barcolor(candleColor)

// pvsra_isClimax â€” used later in composite scoring
pvsra_isClimaxBull = va == 1 and isBull
pvsra_isClimaxBear = va == 1 and not isBull


// =============================================================================
// â”€â”€â”€ CHAOS DUAL â€” Regime + Trend/MR Signals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// =============================================================================
grpChaos = "Chaos Dual â€” Regime & Signals"

ema21  = ta.ema(close, 21)
ema55  = ta.ema(close, 55)
ema100 = ta.ema(close, 100)
ema200 = ta.ema(close, 200)

// Directional Efficiency
lengthEff = 20
netMove   = math.abs(close - close[lengthEff])
totalMove = 0.0
for i = 0 to lengthEff - 1
    totalMove += math.abs(close[i] - close[i + 1])
efficiency    = totalMove != 0 ? netMove / totalMove : 0
trendRegime   = efficiency > 0.4

// Wick Dominance
body       = math.abs(close - open)
upperWick  = high - math.max(close, open)
lowerWick  = math.min(close, open) - low
wickRatio  = body != 0 ? (upperWick + lowerWick) / body : 0
sweepCondition = wickRatio > 2

// Range Persistence
atr_14          = ta.atr(14)
largeRange      = (high - low) > atr_14 * 1.2
rangePersistence = math.sum(largeRange ? 1 : 0, 5)
impulseCondition = rangePersistence >= 3

// Regime Decision
isTrend = trendRegime and impulseCondition and not sweepCondition
isSweep = not trendRegime or sweepCondition

// Trend signals
bullStructure = ema21 > ema55 and ema55 > ema100
bearStructure = ema21 < ema55 and ema55 < ema100

trendBuy  = isTrend and bullStructure and close > ema55
trendSell = isTrend and bearStructure and close < ema55

// Mean-reversion signals (FIXED: sweep gates MR â€” no longer contradictory)
// wickRatio > 2 = sweep condition = we ARE in a sweep, so MR fires only in sweeps
mrBuy  = isSweep and close < ema21 and wickRatio > 2
mrSell = isSweep and close > ema21 and wickRatio > 2

// EMA plots
plot(ema21,  'EMA 21',  color=color.teal,   linewidth=2)
plot(ema55,  'EMA 55',  color=color.orange, linewidth=2)
plot(ema100, 'EMA 100', color=color.blue,   linewidth=2)
plot(ema200, 'EMA 200', color=color.red,    linewidth=1, display=display.none)  // available but hidden â€” used in scoring

// Signals (individual shapes â€” Stage 3 will condense into composite)
plotshape(trendBuy,  location=location.belowbar, style=shape.triangleup,   color=color.green, size=size.small, title="Trend Buy")
plotshape(trendSell, location=location.abovebar, style=shape.triangledown, color=color.red,   size=size.small, title="Trend Sell")
plotshape(mrBuy,     location=location.belowbar, style=shape.circle,       color=color.lime,  size=size.tiny,  title="MR Buy")
plotshape(mrSell,    location=location.abovebar, style=shape.circle,       color=color.maroon,size=size.tiny,  title="MR Sell")


// =============================================================================
// â”€â”€â”€ RSI SUPPLY/DEMAND ZONES â€” Refactored from 4Ã— copy-paste into function â”€â”€â”€
// =============================================================================
// FIX: All 4 instances had a silent bug where the "85 / 15" dropdown option
//      was never handled in the ternary chain and silently resolved to 100/0.
//      The helper function below fixes this once for all instances.

// Helper: parse OB/OS string to numeric levels (85/15 now correctly handled)
f_parse_ob(s) =>
    s == "70 / 30" ? 70 : s == "75 / 25" ? 75 : s == "80 / 20" ? 80 :
     s == "85 / 15" ? 85 : s == "90 / 10" ? 90 : s == "95 / 5" ? 95 : 70
f_parse_os(s) =>
    s == "70 / 30" ? 30 : s == "75 / 25" ? 25 : s == "80 / 20" ? 20 :
     s == "85 / 15" ? 15 : s == "90 / 10" ? 10 : s == "95 / 5" ? 5 : 30

// Core RSI S/D function â€” returns [sdHigh, sdLow, resHigh, resLow, supHigh, supLow, priceEntered]
f_rsi_sd(rsiLen, obosStr, confirmBars) =>
    rsiVal  = ta.rsi(close, rsiLen)
    ob      = f_parse_ob(obosStr)
    os      = f_parse_os(obosStr)

    inc_up   = rsiVal > ob ? 1 : 0
    inc_down = rsiVal < os ? 1 : 0
    inc_both = inc_up == 1 or inc_down == 1 ? 1 : 0

    // S/D zone (both extremes)
    var int rsx = 0
    rsx := inc_both == 1 ? nz(rsx[1], 0) + 1 : 0
    rxH = rsx >= confirmBars ? high : na
    rxL = rsx >= confirmBars ? low  : na
    rH  = fixnan(rxH)
    rL  = fixnan(rxL)

    // Resistance zone (OB only)
    var int rsu = 0
    rsu := inc_up == 1 ? nz(rsu[1], 0) + 1 : 0
    rssH = rsu >= confirmBars ? high : na
    rssL = rsu >= confirmBars ? low  : na
    resH = fixnan(rssH)
    resL = fixnan(rssL)

    // Support zone (OS only)
    var int rsd = 0
    rsd := inc_down == 1 ? nz(rsd[1], 0) + 1 : 0
    rsrH = rsd >= confirmBars ? high : na
    rsrL = rsd >= confirmBars ? low  : na
    supH = fixnan(rsrH)
    supL = fixnan(rsrL)

    inZone    = close <= rH and close >= rL and rH == rH[1]
    enteredZone = inZone and not (close[1] <= rH[1] and close[1] >= rL[1])
    [rH, rL, resH, resL, supH, supL, enteredZone]

// â”€â”€ Instance 1 (RSI 7) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grpSD1 = "Supply Demand 1 â€” RSI 7"
ShowSD1   = input(false, "Supply Demand Zone", group=grpSD1, inline="SD1")
ShowSZ1   = input(false, "Support Zone",       group=grpSD1, inline="SD1")
ShowRZ1   = input(false, "Resistance Zone",    group=grpSD1, inline="SD1")
RSI1Len   = input.int(7,   "RSI Length",       group=grpSD1)
RSI1OBOS  = input.string("70 / 30", "OB / OS", options=["70 / 30","75 / 25","80 / 20","85 / 15","90 / 10","95 / 5"], group=grpSD1)
RSI1Conf  = input.int(3,  "Confirmation Bars", group=grpSD1)
RSI1SDCol = input(color.new(color.blue, 85), "S/D Fill", group=grpSD1, inline="F1")
RSI1SupCol= input(color.new(color.lime, 92), "Support",  group=grpSD1, inline="F1")
RSI1ResCol= input(color.new(color.red,  92), "Resist",   group=grpSD1, inline="F1")

[sd1H, sd1L, res1H, res1L, sup1H, sup1L, entered1] = f_rsi_sd(RSI1Len, RSI1OBOS, RSI1Conf)

sd1Color  = sd1H  != sd1H[1]  ? na : RSI1SDCol
PlotSD1H  = plot(ShowSD1 ? sd1H : na, style=plot.style_cross, linewidth=1, title="SD1 High")
PlotSD1L  = plot(ShowSD1 ? sd1L : na, style=plot.style_cross, linewidth=1, title="SD1 Low")
fill(PlotSD1H, PlotSD1L, color=sd1Color, title="SD1 Fill")
alertcondition(entered1, title='Alert - Price Enters S/D Zone 1', message='Price Enters S/D Zone 1')

// â”€â”€ Instance 2 (RSI 21 â€” SLOW confirmation) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RSI 7 = fast early detector. RSI 21 = slow institutional confirmation.
// When both zones overlap at the same price level â†’ strongest S/D signal.
// RSI 14 and RSI 28 removed â€” Z-Score covers that statistical band better.
grpSD2 = "Supply Demand 2 â€” RSI 21 (Slow)"
ShowSD2   = input(true,  "Supply Demand Zone", group=grpSD2, inline="SD2")
ShowSZ2   = input(false, "Support Zone",       group=grpSD2, inline="SD2")
ShowRZ2   = input(false, "Resistance Zone",    group=grpSD2, inline="SD2")
RSI2Len   = input.int(21, "RSI Length",        group=grpSD2)
RSI2OBOS  = input.string("70 / 30", "OB / OS", options=["70 / 30","75 / 25","80 / 20","85 / 15","90 / 10","95 / 5"], group=grpSD2)
RSI2Conf  = input.int(3,  "Confirmation Bars", group=grpSD2)
RSI2SDCol = input(color.new(color.blue, 85), "S/D Fill", group=grpSD2, inline="F2")
RSI2SupCol= input(color.new(color.lime, 92), "Support",  group=grpSD2, inline="F2")
RSI2ResCol= input(color.new(color.red,  92), "Resist",   group=grpSD2, inline="F2")

[sd2H, sd2L, res2H, res2L, sup2H, sup2L, entered2] = f_rsi_sd(RSI2Len, RSI2OBOS, RSI2Conf)

sd2Color  = sd2H != sd2H[1] ? na : RSI2SDCol
PlotSD2H  = plot(ShowSD2 ? sd2H : na, style=plot.style_cross, linewidth=1, title="SD2 High")
PlotSD2L  = plot(ShowSD2 ? sd2L : na, style=plot.style_cross, linewidth=1, title="SD2 Low")
fill(PlotSD2H, PlotSD2L, color=sd2Color, title="SD2 Fill")
alertcondition(entered2, title='Alert - Price Enters S/D Zone 2', message='Price Enters S/D Zone 2 (RSI 21 Slow)')

// Zone overlap: both RSI7 fast AND RSI21 slow confirm same zone â†’ premium signal
sd_dualConfirmBull = entered1 and entered2
sd_dualConfirmBear = entered1 and entered2  // same zones, both signaling

alertcondition(entered1 or entered2, title='Alert - Price Enters Any S/D Zone', message='Price Enters S/D Zone')
alertcondition(sd_dualConfirmBull,   title='Alert - DUAL CONFIRM S/D Zone',     message='â˜… DUAL CONFIRM â€” RSI7 + RSI21 both active at same level')


// =============================================================================
// â”€â”€â”€ RSI SWING LABELS (HH / HL / LH / LL) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// =============================================================================
grpSwing = "RSI Swing Labels"

rsiSource     = input(close,  "RSI Source",     group=grpSwing)
rsiLength     = input.int(7,  "RSI Length",     group=grpSwing)
rsiOverbought = input.int(70, "RSI Overbought", minval=51, maxval=100, group=grpSwing)
rsiOversold   = input.int(30, "RSI Oversold",   minval=1,  maxval=49,  group=grpSwing)

rsiValue    = ta.rsi(rsiSource, rsiLength)
isOverbought_sw = rsiValue >= rsiOverbought
isOversold_sw   = rsiValue <= rsiOversold

var int   laststate = 0
// FIX: hh was initialized to `low` and ll to `high` â€” backward, caused wrong first comparison
var float hh = na
var float ll = na

var label labelll = na
var label labelhh = na
var line  line_up   = na
var line  line_down = na

var float last_actual_label_hh_price = na  // FIX: was 0.0, caused false "LL" on first signal
var float last_actual_label_ll_price = na

obLabelText() =>
    not na(last_actual_label_hh_price) and last_actual_label_hh_price < high ? "HH" : "LH"
osLabelText() =>
    not na(last_actual_label_ll_price) and last_actual_label_ll_price < low  ? "HL" : "LL"

createOverBoughtLabel(isIt) =>
    if isIt
        label.new(bar_index, na, yloc=yloc.abovebar, style=label.style_label_down, color=color.red,   size=size.tiny, text=obLabelText())
    else
        label.new(bar_index, na, yloc=yloc.belowbar, style=label.style_label_up,   color=color.green, size=size.tiny, text=osLabelText())

moveOversoldLabel() =>
    label.set_x(labelll, bar_index)
    label.set_y(labelll, low)
    label.set_text(labelll, osLabelText())
    line.set_x1(line_down, bar_index)
    line.set_y1(line_down, low)

moveOverBoughtLabel() =>
    label.set_x(labelhh, bar_index)
    label.set_y(labelhh, high)
    label.set_text(labelhh, obLabelText())
    line.set_x1(line_up, bar_index)
    line.set_y1(line_up, high)

if laststate == 2 and isOverbought_sw
    hh     := high
    labelhh := createOverBoughtLabel(true)
    last_actual_label_ll_price := label.get_y(labelll)
    labelll_ts    = label.get_x(labelll)
    labelll_price = label.get_y(labelll)
    line_up       := line.new(bar_index, high, labelll_ts, labelll_price, width=1)

if laststate == 1 and isOversold_sw
    ll     := low
    labelll := createOverBoughtLabel(false)
    last_actual_label_hh_price := label.get_y(labelhh)
    labelhh_ts    = label.get_x(labelhh)
    labelhh_price = label.get_y(labelhh)
    line_down     := line.new(bar_index, high, labelhh_ts, labelhh_price, width=1)

if isOverbought_sw
    if na(hh) or high >= hh
        hh := high
        if not na(labelhh)
            moveOverBoughtLabel()
    laststate := 1

if isOversold_sw
    if na(ll) or low <= ll
        ll := low
        if not na(labelll)
            moveOversoldLabel()
    laststate := 2

if laststate == 1 and isOverbought_sw
    if not na(hh) and hh <= high
        hh := high
        moveOverBoughtLabel()

if laststate == 2 and isOversold_sw
    if not na(ll) and ll >= low
        ll := low
        moveOversoldLabel()


// =============================================================================
// â”€â”€â”€ PIVOT RAYS (Sweep detection) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// =============================================================================
grpPivot = "Pivot Rays"

leftBars  = input.int(6,   "Left Bars",       group=grpPivot)
rightBars = input.int(3,   "Right Bars",      group=grpPivot)
topCol    = input.color(color.red,   "High Ray Color", group=grpPivot)
botCol    = input.color(color.green, "Low Ray Color",  group=grpPivot)
_width    = input.int(2,   "Line Width",       group=grpPivot)
maxRays   = input.int(150, "Max Active Rays",  group=grpPivot)

ph = ta.pivothigh(high, leftBars, rightBars)
pl = ta.pivotlow(low,  leftBars, rightBars)

var line[]  highLines  = array.new_line()
var float[] highPrices = array.new_float()
var line[]  lowLines   = array.new_line()
var float[] lowPrices  = array.new_float()

if not na(ph)
    idx = bar_index - rightBars
    l   = line.new(idx, ph, idx + 1, ph, extend=extend.right, color=topCol, width=_width)
    array.push(highLines, l)
    array.push(highPrices, ph)
    if array.size(highLines) > maxRays
        line.delete(array.shift(highLines))
        array.shift(highPrices)

if not na(pl)
    idx = bar_index - rightBars
    l   = line.new(idx, pl, idx + 1, pl, extend=extend.right, color=botCol, width=_width)
    array.push(lowLines, l)
    array.push(lowPrices, pl)
    if array.size(lowLines) > maxRays
        line.delete(array.shift(lowLines))
        array.shift(lowPrices)

if array.size(highLines) > 0
    for i = array.size(highLines) - 1 to 0 by -1
        prc = array.get(highPrices, i)
        l   = array.get(highLines,  i)
        if high > prc
            line.set_extend(l, extend.none)
            line.set_x2(l, bar_index)
            line.set_y2(l, prc)
            array.remove(highLines, i)
            array.remove(highPrices, i)

if array.size(lowLines) > 0
    for i = array.size(lowLines) - 1 to 0 by -1
        prc = array.get(lowPrices, i)
        l   = array.get(lowLines,  i)
        if low < prc
            line.set_extend(l, extend.none)
            line.set_x2(l, bar_index)
            line.set_y2(l, prc)
            array.remove(lowLines, i)
            array.remove(lowPrices, i)


// =============================================================================
// â”€â”€â”€ LOWER-TF INTENSITY CVD (flip-based buy/sell signal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// =============================================================================
grpIntensity = "Lower-TF Intensity"

lowerTF  = input.timeframe("1", "Lower Timeframe", group=grpIntensity)
lookback = input.int(10, "Lookback Bars",           group=grpIntensity)

f_intensity() =>
    dir = close > open ? 1 : close < open ? -1 : 0
    volume * math.abs(close - open) * dir

intensity_ltf = request.security(syminfo.tickerid, lowerTF, f_intensity(), barmerge.gaps_off, barmerge.lookahead_off)

// FIX: replaced fragile ta.cum() subtraction trick with math.sum()
netIntensity = math.sum(intensity_ltf, lookback)

buySignal_intensity  = netIntensity > 0 and netIntensity[1] <= 0
sellSignal_intensity = netIntensity < 0 and netIntensity[1] >= 0

plotshape(buySignal_intensity,  title="Intensity Buy",  style=shape.triangleup,   location=location.belowbar, color=color.lime, size=size.small)
plotshape(sellSignal_intensity, title="Intensity Sell", style=shape.triangledown, location=location.abovebar, color=color.red,  size=size.small)


// =============================================================================
// â”€â”€â”€ CVD (Estimated â€” session-reset) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// =============================================================================
// Note: This is ESTIMATED CVD using bar close vs open direction, not true
//       tick-level bid/ask delta. Labeled accordingly.
grpCVD = "Estimated CVD"

lowerTF2 = input.timeframe("1", "Lower TF for CVD", group=grpCVD)
tfCVD    = input.timeframe("D", "CVD Reset Timeframe", group=grpCVD)

newDay    = ta.change(time(tfCVD)) != 0

vol_ltf   = request.security(syminfo.tickerid, lowerTF2, volume, barmerge.gaps_off, barmerge.lookahead_off)
close_ltf = request.security(syminfo.tickerid, lowerTF2, close,  barmerge.gaps_off, barmerge.lookahead_off)
open_ltf  = request.security(syminfo.tickerid, lowerTF2, open,   barmerge.gaps_off, barmerge.lookahead_off)

dir_ltf   = close_ltf > open_ltf ? 1 : close_ltf < open_ltf ? -1 : 0
var float cvd_ltf = 0.
cvd_ltf  := newDay ? 0. : nz(cvd_ltf[1]) + vol_ltf * dir_ltf

// Anchor / divergence tracking (bullish)
var float anchorPrice = na
var float anchorCVD   = na
var int   anchorBar   = na

if newDay
    anchorPrice := na
    anchorCVD   := na
    anchorBar   := na

if na(anchorCVD) or cvd_ltf < anchorCVD
    anchorCVD   := cvd_ltf
    anchorPrice := low
    anchorBar   := bar_index

var float bullDivPrice = na
var int   bullDivBar   = na

if not na(anchorPrice)
    if na(bullDivBar) and low < anchorPrice and cvd_ltf > anchorCVD
        bullDivBar   := bar_index
        bullDivPrice := low
    if not na(bullDivBar) and low < bullDivPrice and cvd_ltf > anchorCVD
        bullDivBar   := bar_index
        bullDivPrice := low
    if not na(bullDivBar) and cvd_ltf <= anchorCVD
        bullDivBar   := na
        bullDivPrice := na

// Anchor / divergence tracking (bearish)
var float bearAnchorPrice = na
var float bearAnchorCVD   = na
var int   bearAnchorBar   = na

if newDay
    bearAnchorPrice := na
    bearAnchorCVD   := na
    bearAnchorBar   := na

if na(bearAnchorCVD) or cvd_ltf > bearAnchorCVD
    bearAnchorCVD   := cvd_ltf
    bearAnchorPrice := high
    bearAnchorBar   := bar_index

var float bearDivPrice = na
var int   bearDivBar   = na

if not na(bearAnchorPrice)
    if na(bearDivBar) and high > bearAnchorPrice and cvd_ltf < bearAnchorCVD
        bearDivBar   := bar_index
        bearDivPrice := high
    if not na(bearDivBar) and high > bearDivPrice and cvd_ltf < bearAnchorCVD
        bearDivBar   := bar_index
        bearDivPrice := high
    if not na(bearDivBar) and cvd_ltf >= bearAnchorCVD
        bearDivBar   := na
        bearDivPrice := na

// CVD bullish divergence active flag (used in composite scoring)
cvdBullDiv = not na(bullDivBar) and bar_index == bullDivBar
cvdBearDiv = not na(bearDivBar) and bar_index == bearDivBar

plot(cvd_ltf, color=color.blue, linewidth=2, title="Est. CVD"
hline(0, "CVD Zero", color=color.gray, linestyle=hline.style_dashed)

plotshape(not na(anchorBar)    and bar_index == anchorBar    ? cvd_ltf : na, title="CVD Bull Anchor", style=shape.circle, size=size.tiny, color=color.gray,   location=location.belowbar)
plotshape(cvdBullDiv                                                        ? cvd_ltf : na, title="CVD Bull Div",    style=shape.circle, size=size.tiny, color=color.blue,   location=location.belowbar)
plotshape(not na(bearAnchorBar) and bar_index == bearAnchorBar ? cvd_ltf : na, title="CVD Bear Anchor", style=shape.circle, size=size.tiny, color=color.gray,   location=location.abovebar)
plotshape(cvdBearDiv                                                        ? cvd_ltf : na, title="CVD Bear Div",    style=shape.circle, size=size.tiny, color=color.purple, location=location.abovebar)


// =============================================================================
// â”€â”€â”€ LIQUIDATION LEVELS + OI DELTA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// =============================================================================
grpLiqOI = "ðŸ’§ Liq + OI Delta"

liqPct        = input.float(1.0,  "Liq Hunt %",       minval=0.1, maxval=5, group=grpLiqOI,
     tooltip="Distance from entry where 100x isolated longs/shorts get liquidated. Market hunts these clusters â€” the longer they sit naked, the stronger the magnet.")
showPriceLiq  = input.bool(true,  "Show Entry Liqs",  group=grpLiqOI)
showSwingLiq  = input.bool(true,  "Show Swing Liqs",  group=grpLiqOI)
swingLookback = input.int(5,      "Swing Lookback",   minval=1, maxval=20, group=grpLiqOI)
oiOffsetVal   = input.int(2000,   "OI Offset",        minval=100, maxval=10000, group=grpLiqOI)

symbolLongs  = "BITFINEX:BTCUSDLONGS"
symbolShorts = "BITFINEX:BTCUSDSHORTS"

price_oi = request.security("BINANCE:BTCUSDT.P",    timeframe.period, close)
oi       = request.security("BINANCE:BTCUSDT.P_OI", timeframe.period, close)
longs    = request.security(symbolLongs,  timeframe.period, close)
shorts   = request.security(symbolShorts, timeframe.period, close)

oiDelta    = oi    - oi[1]
priceDelta = price_oi - price_oi[1]

newLongs      = priceDelta > 0 and oiDelta > 0
newShorts     = priceDelta < 0 and oiDelta > 0
shortsClosing = priceDelta > 0 and oiDelta < 0
longsClosing  = priceDelta < 0 and oiDelta < 0
chopOrAbsorb  = math.abs(oiDelta) <= 0.1 * math.abs(priceDelta)

var float longEntryPrice  = na
var float shortEntryPrice = na
var int   longEntryBar    = na
var int   shortEntryBar   = na

if newLongs
    longEntryPrice := price_oi
    longEntryBar   := bar_index

if newShorts
    shortEntryPrice := price_oi
    shortEntryBar   := bar_index

// Liquidation levels â€” 1% = 100x isolated hunt zone
longLiq  = not na(longEntryPrice)  ? longEntryPrice  * (1 - liqPct / 100) : na
shortLiq = not na(shortEntryPrice) ? shortEntryPrice * (1 + liqPct / 100) : na

swingHigh     = ta.highest(high, swingLookback)
swingLow      = ta.lowest(low,  swingLookback)
longSwingLiq  = showSwingLiq ? swingLow  * (1 - liqPct / 100) : na
shortSwingLiq = showSwingLiq ? swingHigh * (1 + liqPct / 100) : na

longsUnderwater  = not na(longEntryPrice)  and price_oi < longEntryPrice
shortsUnderwater = not na(shortEntryPrice) and price_oi > shortEntryPrice

// OI flow color
flowColor =
     newLongs      ? color.lime   :
     newShorts     ? color.red    :
     shortsClosing ? color.purple :
     longsClosing  ? color.orange :
     color.gray

// OI Delta offset histogram (FIX: was plotcandle which rendered at wrong scale)
lowest_50  = ta.lowest(low, 50)
oiOffset   = lowest_50 - oiOffsetVal

// Normalize OI delta to a visual scale relative to ATR so it doesn't blow up
atr_norm      = ta.atr(14)
oiDeltaNorm   = atr_norm != 0 ? (oiDelta / math.abs(oiDelta + 0.0001)) * atr_norm * 0.3 : 0

plotcandle(oiOffset, oiOffset + oiDeltaNorm, oiOffset, oiOffset + oiDeltaNorm,
     title="OI Delta", color=flowColor, bordercolor=color.new(flowColor, 70), wickcolor=color.new(flowColor, 70))
plot(oiOffset + oiDeltaNorm, style=plot.style_line, color=color.new(flowColor, 70), title="OI Delta Line", linewidth=2)

bgcolor(longsUnderwater  ? color.new(color.red,   90) : na, title="Longs Underwater")
bgcolor(shortsUnderwater ? color.new(color.green,  90) : na, title="Shorts Underwater")

plot(showPriceLiq ? longEntryPrice  : na, title="Long Entry",  color=color.lime,   style=plot.style_stepline, linewidth=1)
plot(showPriceLiq ? shortEntryPrice : na, title="Short Entry", color=color.red,    style=plot.style_stepline, linewidth=1)
plot(showPriceLiq ? longLiq         : na, title="Long Liq",    color=color.orange, style=plot.style_stepline, linewidth=1)
plot(showPriceLiq ? shortLiq        : na, title="Short Liq",   color=color.purple, style=plot.style_stepline, linewidth=1)
plot(showSwingLiq ? longSwingLiq    : na, title="Long Swing Liq",  color=color.orange, style=plot.style_stepline, linewidth=2)
plot(showSwingLiq ? shortSwingLiq   : na, title="Short Swing Liq", color=color.purple, style=plot.style_stepline, linewidth=2)


// =============================================================================
// STAGE 2 â€” Z-Score Engine + Regime Labeling
//   â€¢ Dual Z-Score: NWE-based (primary, 40% weight) + SMA-based (confirmation)
//   â€¢ Regime label with 3-bar grace period on transitions
//   â€¢ Z-Score plots in sub-pane with gradient zone backgrounds
//   â€¢ RSI(14) overlaid at 30% opacity as secondary confirmation
// =============================================================================

// =============================================================================
// â”€â”€â”€ Z-SCORE ENGINE â€” 4-LEVEL HF-GRADE FUNNEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// =============================================================================
// Industry-standard Z-Score levels used by quant desks (Citadel / Two Sigma style):
//   Â±1.5 = 87% boundary â€” HF entry zone for high-freq mean reversion (PRE-ALERT)
//   Â±2.0 = 95% boundary â€” Primary signal (standard institutional entry)
//   Â±2.5 = 99% boundary â€” High conviction, scale in
//   Â±3.0 = 99.7% boundary â€” Capitulation / max extreme, rare, all-in
//
// Price Projection Zones: Z-Score levels are back-calculated to actual price
// so you can see WHERE on the chart the Â±1.5/2/2.5/3 thresholds currently sit.
// These are your PRE-LOCATED buy/sell interest areas BEFORE price reaches them.
// =============================================================================
grpZ = "Z-Score Engine"

zLen       = input.int(100, "Z-Score Lookback", minval=20, maxval=500, group=grpZ)
showZScore = input.bool(true, "Show Z-Score Pane",   group=grpZ)
showZProj  = input.bool(true, "Show Price Projection Zones", group=grpZ,
     tooltip="Draws the Â±1.5/2/2.5/3 Z-Score levels directly on the price chart as horizontal zones. These are your pre-located areas where signals are LIKELY to fire â€” watch them in advance.")

// â”€â”€ Primary Z-Score vs NWE baseline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
nwe_baseline = repaint ? ta.sma(close, zLen) : out
nwe_stdev    = ta.stdev(close, zLen)
zScore_nwe   = nwe_stdev != 0 ? (close - nwe_baseline) / nwe_stdev : 0.

// â”€â”€ Secondary Z-Score vs SMA baseline (confirmation) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sma_baseline = ta.sma(close, zLen)
sma_stdev    = ta.stdev(close, zLen)
zScore_sma   = sma_stdev != 0 ? (close - sma_baseline) / sma_stdev : 0.

// â”€â”€ Composite Z-Score: 60% NWE (adaptive) + 40% SMA (stable) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
zScore = 0.6 * zScore_nwe + 0.4 * zScore_sma

// â”€â”€ RSI(14): secondary confirmation, scaled to Z-Score range for overlay â”€â”€â”€â”€â”€â”€
rsi14Raw    = ta.rsi(close, 14)
rsi14Scaled = (rsi14Raw - 50) / 12   // centers at 0, roughly Â±4 range

// â”€â”€ 4-Level threshold flags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
z_pre_bull  = zScore <= -1.5   // 87% â€” entering funnel, watch
z_bull_2    = zScore <= -2.0   // 95% â€” primary signal level
z_bull_2h   = zScore <= -2.5   // 99% â€” scale in level
z_bull_3    = zScore <= -3.0   // 99.7% â€” max extreme / capitulation

z_pre_bear  = zScore >=  1.5
z_bear_2    = zScore >=  2.0
z_bear_2h   = zScore >=  2.5
z_bear_3    = zScore >=  3.0

// Convenience aliases used by composite scorer
zBull = z_bull_2
zBear = z_bear_2

// â”€â”€ Z-Score sub-pane: color shifts through the funnel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
zColor = zScore <= -3.0 ? color.new(#39ff14, 0)  :   // max extreme â€” full bright green
         zScore <= -2.5 ? color.new(#39ff14, 20) :   // scale-in â€” bright
         zScore <= -2.0 ? color.new(#39ff14, 40) :   // primary â€” medium
         zScore <= -1.5 ? color.new(#39ff14, 65) :   // pre-alert â€” soft
         zScore >=  3.0 ? color.new(#ff3131, 0)  :
         zScore >=  2.5 ? color.new(#ff3131, 20) :
         zScore >=  2.0 ? color.new(#ff3131, 40) :
         zScore >=  1.5 ? color.new(#ff3131, 65) :
         color.new(#4a5568, 50)

plot(showZScore ? zScore      : na, "Z-Score",      color=zColor,                linewidth=2
plot(showZScore ? zScore_nwe  : na, "Z-Score NWE",  color=color.new(#00e5cc,60), linewidth=1
plot(showZScore ? rsi14Scaled : na, "RSI14 Scaled", color=color.new(#ffffff,75), linewidth=1

// Level lines in sub-pane
hline( 3.0, "Z +3.0 Capitulation", color=color.new(#ff3131, 10), linestyle=hline.style_solid)
hline( 2.5, "Z +2.5 Scale",        color=color.new(#ff3131, 30), linestyle=hline.style_dashed)
hline( 2.0, "Z +2.0 Primary",      color=color.new(#ff3131, 50), linestyle=hline.style_dashed)
hline( 1.5, "Z +1.5 Pre-alert",    color=color.new(#ff3131, 75), linestyle=hline.style_dotted)
hline( 0.0, "Z Zero",              color=color.new(#4a5568, 50))
hline(-1.5, "Z -1.5 Pre-alert",    color=color.new(#39ff14, 75), linestyle=hline.style_dotted)
hline(-2.0, "Z -2.0 Primary",      color=color.new(#39ff14, 50), linestyle=hline.style_dashed)
hline(-2.5, "Z -2.5 Scale",        color=color.new(#39ff14, 30), linestyle=hline.style_dashed)
hline(-3.0, "Z -3.0 Capitulation", color=color.new(#39ff14, 10), linestyle=hline.style_solid)

// Funnel zone backgrounds in sub-pane (deeper = brighter)
bgcolor(showZScore and zScore >= 3.0  ? color.new(#ff3131, 70) : na, title="Z Pane +3"
bgcolor(showZScore and zScore >= 2.5 and zScore < 3.0 ? color.new(#ff3131, 82) : na, title="Z Pane +2.5"
bgcolor(showZScore and zScore >= 2.0 and zScore < 2.5 ? color.new(#ff3131, 90) : na, title="Z Pane +2.0"
bgcolor(showZScore and zScore >= 1.5 and zScore < 2.0 ? color.new(#ff3131, 95) : na, title="Z Pane +1.5"
bgcolor(showZScore and zScore <= -3.0 ? color.new(#39ff14, 70) : na, title="Z Pane -3"
bgcolor(showZScore and zScore <= -2.5 and zScore > -3.0 ? color.new(#39ff14, 82) : na, title="Z Pane -2.5"
bgcolor(showZScore and zScore <= -2.0 and zScore > -2.5 ? color.new(#39ff14, 90) : na, title="Z Pane -2.0"
bgcolor(showZScore and zScore <= -1.5 and zScore > -2.0 ? color.new(#39ff14, 95) : na, title="Z Pane -1.5"

// =============================================================================
// â”€â”€â”€ Z-SCORE PRICE PROJECTION ZONES (on main price chart) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// =============================================================================
// Back-calculate where each Z-Score level sits in price terms RIGHT NOW.
// These are your pre-located interest areas â€” price approaching Â±1.5 means
// the Â±2.0 BUY/SELL ZONE is only one volatility move away. Watch these lines.

// Price at each Z-Score level = baseline + (z_level Ã— stdev)
// Using blended baseline/stdev to match composite Z-Score
blend_baseline = 0.6 * nwe_baseline + 0.4 * sma_baseline
blend_stdev    = 0.6 * nwe_stdev    + 0.4 * sma_stdev

// Bull-side projected prices (below current)
zProj_bull_1h  = blend_baseline - 1.5 * blend_stdev   // pre-alert
zProj_bull_2   = blend_baseline - 2.0 * blend_stdev   // primary
zProj_bull_2h  = blend_baseline - 2.5 * blend_stdev   // scale-in
zProj_bull_3   = blend_baseline - 3.0 * blend_stdev   // capitulation

// Bear-side projected prices (above current)
zProj_bear_1h  = blend_baseline + 1.5 * blend_stdev
zProj_bear_2   = blend_baseline + 2.0 * blend_stdev
zProj_bear_2h  = blend_baseline + 2.5 * blend_stdev
zProj_bear_3   = blend_baseline + 3.0 * blend_stdev

// Plot projection zones on the main price chart
// Outer glow + core line for each level
plot(showZProj ? zProj_bull_1h : na, "Buy Pre-alert 1.5 Glow", color=color.new(#39ff14, 85), linewidth=4)
plot(showZProj ? zProj_bull_1h : na, "Buy Pre-alert 1.5",      color=color.new(#39ff14, 65), linewidth=1, style=plot.style_stepline)

plot(showZProj ? zProj_bull_2  : na, "Buy Primary 2.0 Glow",   color=color.new(#39ff14, 70), linewidth=5)
plot(showZProj ? zProj_bull_2  : na, "Buy Primary 2.0",        color=color.new(#39ff14, 40), linewidth=2, style=plot.style_stepline)

plot(showZProj ? zProj_bull_2h : na, "Buy Scale 2.5 Glow",     color=color.new(#39ff14, 55), linewidth=6)
plot(showZProj ? zProj_bull_2h : na, "Buy Scale 2.5",          color=color.new(#39ff14, 20), linewidth=2, style=plot.style_stepline)

plot(showZProj ? zProj_bull_3  : na, "Buy Cap 3.0 Glow",       color=color.new(#39ff14, 40), linewidth=7)
plot(showZProj ? zProj_bull_3  : na, "Buy Cap 3.0",            color=color.new(#39ff14, 0),  linewidth=3, style=plot.style_stepline)

plot(showZProj ? zProj_bear_1h : na, "Sell Pre-alert 1.5 Glow",color=color.new(#ff3131, 85), linewidth=4)
plot(showZProj ? zProj_bear_1h : na, "Sell Pre-alert 1.5",     color=color.new(#ff3131, 65), linewidth=1, style=plot.style_stepline)

plot(showZProj ? zProj_bear_2  : na, "Sell Primary 2.0 Glow",  color=color.new(#ff3131, 70), linewidth=5)
plot(showZProj ? zProj_bear_2  : na, "Sell Primary 2.0",       color=color.new(#ff3131, 40), linewidth=2, style=plot.style_stepline)

plot(showZProj ? zProj_bear_2h : na, "Sell Scale 2.5 Glow",    color=color.new(#ff3131, 55), linewidth=6)
plot(showZProj ? zProj_bear_2h : na, "Sell Scale 2.5",         color=color.new(#ff3131, 20), linewidth=2, style=plot.style_stepline)

plot(showZProj ? zProj_bear_3  : na, "Sell Cap 3.0 Glow",      color=color.new(#ff3131, 40), linewidth=7)
plot(showZProj ? zProj_bear_3  : na, "Sell Cap 3.0",           color=color.new(#ff3131, 0),  linewidth=3, style=plot.style_stepline)


// =============================================================================
// â”€â”€â”€ REGIME DETECTION + LABELING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// =============================================================================
grpRegime = "Regime"

showRegimeLabel = input.bool(true, "Show Regime Label", group=grpRegime,
     tooltip="Shows current market regime. Grace period of 3 bars on transitions before regime flips â€” reduces whipsaw false switches.")
graceLen        = input.int(3, "Transition Grace Bars", minval=0, maxval=10, group=grpRegime)

// â”€â”€ Grace period: regime only flips after N consecutive bars confirming new regime â”€â”€
var int trendCount = 0
var int sweepCount = 0
var bool regimeTrend = false   // true = TREND, false = SWEEP/CHOP

trendCount := isTrend ? trendCount + 1 : 0
sweepCount := isSweep ? sweepCount + 1 : 0

// Flip only after grace period
if trendCount >= graceLen
    regimeTrend := true
if sweepCount >= graceLen
    regimeTrend := false

// In transition: neither counter has reached grace period
inTransition = trendCount < graceLen and sweepCount < graceLen

regimeStr   = regimeTrend ? "TREND â–²" : inTransition ? "FLIP..." : "SWEEP â†”"
regimeColor = regimeTrend ? color.new(#00f5ff, 0) : inTransition ? color.new(#ffc400, 0) : color.new(#ff8800, 0)

// Regime label (top-left corner, always visible)
var label regimeLabel = na
label.delete(regimeLabel)
regimeLabel := label.new(
     bar_index, high * 1.0001,
     text      = regimeStr,
     xloc      = xloc.bar_index,
     yloc      = yloc.abovebar,
     color     = color.new(#0d0d12, 85),
     textcolor = regimeColor,
     style     = label.style_label_down,
     size      = size.small)



// =============================================================================
// STAGE 3 â€” Composite Scoring + BUY ZONE / SELL ZONE Signal
//   Votes from each module (-5 to +5 total):
//     Z-Score extreme:      Â±2 pts  (primary, most weight)
//     NWE band cross:       Â±1 pt
//     CVD divergence:       Â±1 pt
//     RSI(14) OB/OS:        Â±0.5 pt (small edge over Z-Score alone)
//     PVSRA climax candle:  Â±0.5 pt (volume confirmation)
//     EMA200 bias filter:   Â±0 pt (gates direction only, no score change)
//   Threshold: score â‰¥ +3 = BUY ZONE, score â‰¤ -3 = SELL ZONE
// =============================================================================

// =============================================================================
// â”€â”€â”€ COMPOSITE SCORING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// =============================================================================
grpComposite = "Composite Signal"

compositeThresh = input.float(3.0, "Signal Threshold (max 5.5)", minval=1.0, maxval=5.5, step=0.5, group=grpComposite,
     tooltip="Score needed for BUY ZONE or SELL ZONE label. 3.0 = balanced. 3.5+ = high conviction only. Z-Score alone maxes at 2.0 so you need at least one more confirming factor.")
showComposite   = input.bool(true, "Show Composite Labels", group=grpComposite)

// â”€â”€ NWE band cross â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
nweCrossUp   = not repaint and ta.crossunder(close, lower)
nweCrossDown = not repaint and ta.crossover(close,  upper)

// â”€â”€ EMA200 directional bias (gate only â€” doesn't inflate score) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ema200bullBias = close > ema200
ema200bearBias = close < ema200

// â”€â”€ RSI(14) OB/OS â€” graded: deeper = more weight â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
rsi14Bull   = rsi14Raw <= 30    // standard oversold
rsi14BullEx = rsi14Raw <= 20    // extreme oversold â€” extra edge
rsi14Bear   = rsi14Raw >= 70
rsi14BearEx = rsi14Raw >= 80

// â”€â”€ Z-Score vote: GRADUATED across 4 levels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// This is the primary signal â€” deeper extremes get more weight.
// At Â±3.0 Z (capitulation) alone you're at 2.0 pts, combine with ANY other
// confirmation and you cross threshold. That's the HF-grade discipline.
score_z =
     zScore <= -3.0 ? 2.0  :   // capitulation = max weight
     zScore <= -2.5 ? 1.75 :   // scale-in level
     zScore <= -2.0 ? 1.5  :   // primary signal
     zScore <= -1.5 ? 0.75 :   // pre-alert (not enough alone, needs confirmation)
     zScore >=  3.0 ? -2.0 :
     zScore >=  2.5 ? -1.75:
     zScore >=  2.0 ? -1.5 :
     zScore >=  1.5 ? -0.75:
     0.0

// â”€â”€ NWE band cross: 1.0 pt â€” confirms Z-Score with actual price channel break â”€
score_nwe   = nweCrossUp   ? 1.0  : nweCrossDown  ? -1.0  : 0.0

// â”€â”€ CVD divergence: 1.0 pt â€” volume disagreeing with price = smart money signal
score_cvd   = cvdBullDiv   ? 1.0  : cvdBearDiv    ? -1.0  : 0.0

// â”€â”€ RSI(14): graduated â€” extreme OS/OB gets more edge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
score_rsi   = rsi14BullEx  ? 0.75 : rsi14Bull     ?  0.5  :
              rsi14BearEx  ? -0.75: rsi14Bear      ? -0.5  : 0.0

// â”€â”€ PVSRA climax: 0.5 pt â€” high volume confirmation of extreme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
score_pvsra = pvsra_isClimaxBull ? 0.5 : pvsra_isClimaxBear ? -0.5 : 0.0

// â”€â”€ RSI S/D dual confirm bonus: 0.25 pt â€” both fast+slow RSI agree â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
score_sd    = sd_dualConfirmBull ? 0.25 : 0.0

compositeScore = score_z + score_nwe + score_cvd + score_rsi + score_pvsra + score_sd

// â”€â”€ EMA200 gate: directional filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buyZone  = compositeScore >=  compositeThresh and (ema200bullBias or na(ema200))
sellZone = compositeScore <= -compositeThresh and (ema200bearBias or na(ema200))

// â”€â”€ BUY ZONE label text shows Z-Score tier â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
zTierBull = z_bull_3 ? "Z:-3 CAPIT" : z_bull_2h ? "Z:-2.5 SCALE" : z_bull_2 ? "Z:-2.0 PRIMARY" : z_pre_bull ? "Z:-1.5 PRE" : "Z:0"
zTierBear = z_bear_3 ? "Z:+3 CAPIT" : z_bear_2h ? "Z:+2.5 SCALE" : z_bear_2 ? "Z:+2.0 PRIMARY" : z_pre_bear ? "Z:+1.5 PRE" : "Z:0"

if showComposite and buyZone
    lbl = label.new(
         bar_index, low,
         text      = "â–² BUY ZONE  " + zTierBull + "\n" + str.tostring(compositeScore, "#.##") + " / 5.5",
         yloc      = yloc.belowbar,
         style     = label.style_label_up,
         color     = color.new(#001a0d, 10),
         textcolor = #39ff14,
         size      = size.normal,
         tooltip   = "Z-NWE:" + str.tostring(zScore_nwe, "#.##") +
                     " | Z-SMA:" + str.tostring(zScore_sma, "#.##") +
                     " | Composite Z:" + str.tostring(zScore, "#.##") +
                     " | CVD:" + str.tostring(math.round(cvd_ltf)) +
                     " | RSI14:" + str.tostring(math.round(rsi14Raw)) +
                     " | Score:" + str.tostring(compositeScore, "#.##"))

if showComposite and sellZone
    lbl = label.new(
         bar_index, high,
         text      = "â–¼ SELL ZONE  " + zTierBear + "\n" + str.tostring(compositeScore, "#.##") + " / 5.5",
         yloc      = yloc.abovebar,
         style     = label.style_label_down,
         color     = color.new(#1a0007, 10),
         textcolor = #ff00aa,
         size      = size.normal,
         tooltip   = "Z-NWE:" + str.tostring(zScore_nwe, "#.##") +
                     " | Z-SMA:" + str.tostring(zScore_sma, "#.##") +
                     " | Composite Z:" + str.tostring(zScore, "#.##") +
                     " | CVD:" + str.tostring(math.round(cvd_ltf)) +
                     " | RSI14:" + str.tostring(math.round(rsi14Raw)) +
                     " | Score:" + str.tostring(compositeScore, "#.##"))

// â”€â”€ Expose composite score as a plot for the sub-pane (optional visual) â”€â”€â”€â”€â”€â”€â”€
plot(compositeScore, "Composite Score", color=compositeScore >= compositeThresh ? color.new(#39ff14, 0) :
     compositeScore <= -compositeThresh ? color.new(#ff00aa, 0) : color.new(#4a5568, 50),
     linewidth=2
hline( compositeThresh, "Buy Threshold",  color=color.new(#39ff14, 60), linestyle=hline.style_dashed
hline(-compositeThresh, "Sell Threshold", color=color.new(#ff00aa, 60), linestyle=hline.style_dashed

// Alert conditions
alertcondition(buyZone,  title="BUY ZONE",  message="ðŸŸ¢ BUY ZONE â€” Composite score fired")
alertcondition(sellZone, title="SELL ZONE", message="ðŸ”´ SELL ZONE â€” Composite score fired")



// =============================================================================
// STAGE 4 â€” Liquidation Nakedness Tracker + OI Normalization
//   â€¢ Tracks how many bars each liq level has been "naked" (untouched)
//   â€¢ Magnet strength: line glows brighter + thickness grows with age
//   â€¢ Age shown as label next to the line (bars naked)
//   â€¢ Leverage input for true liq distance calculation
//   â€¢ OI arrows replaced with normalized histogram (no more scale blow-up)
// =============================================================================

// =============================================================================
// â”€â”€â”€ LIQUIDATION NAKEDNESS TRACKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// =============================================================================
grpLiqNaked = "ðŸ’§ Liq Nakedness Tracker"

showNakedAge  = input.bool(true,  "Show Age Label",       group=grpLiqNaked)
nakedGlow     = input.bool(true,  "Glow by Age",          group=grpLiqNaked)
nakedLvl1     = input.int(20,     "Glow Stage 1 (bars)",  group=grpLiqNaked, minval=5,
     tooltip="After this many bars naked, line brightens to Stage 1")
nakedLvl2     = input.int(50,     "Glow Stage 2 (bars)",  group=grpLiqNaked, minval=10)
nakedLvl3     = input.int(100,    "Glow Stage 3 (bars)",  group=grpLiqNaked, minval=20,
     tooltip="Stage 3 = maximum magnet â€” these levels are prime SFP / sweep targets")

// Track age of long liq level (bars since it was last reset by a new long entry)
var int longLiqAge  = 0
var int shortLiqAge = 0

// Reset age counter when a new entry is set
longLiqAge  := newLongs  ? 0 : na(longEntryPrice)  ? 0 : longLiqAge  + 1
shortLiqAge := newShorts ? 0 : na(shortEntryPrice) ? 0 : shortLiqAge + 1

// Was the liq level swept this bar? (price wicked through it)
longLiqSwept  = not na(longLiq)  and low  <= longLiq
shortLiqSwept = not na(shortLiq) and high >= shortLiq

// Reset age on sweep (new hunt cycle begins)
longLiqAge  := longLiqSwept  ? 0 : longLiqAge
shortLiqAge := shortLiqSwept ? 0 : shortLiqAge

// â”€â”€ Nakedness glow: transparency decreases (more opaque) as age increases â”€â”€â”€â”€â”€
// Long liq = gold (#ffd700), fades from transparent to bright gold
f_liq_alpha(age, l1, l2, l3) =>
    age < l1 ? 80 : age < l2 ? 60 : age < l3 ? 35 : 10   // lower = more opaque = brighter

longLiqAlpha  = f_liq_alpha(longLiqAge,  nakedLvl1, nakedLvl2, nakedLvl3)
shortLiqAlpha = f_liq_alpha(shortLiqAge, nakedLvl1, nakedLvl2, nakedLvl3)

longLiqWidth  = longLiqAge  < nakedLvl1 ? 1 : longLiqAge  < nakedLvl2 ? 2 : longLiqAge  < nakedLvl3 ? 3 : 4
shortLiqWidth = shortLiqAge < nakedLvl1 ? 1 : shortLiqAge < nakedLvl2 ? 2 : shortLiqAge < nakedLvl3 ? 3 : 4

longLiqColor  = color.new(#ffd700, longLiqAlpha)   // Gold â€” long liquidation (preserved)
shortLiqColor = color.new(#8b00ff, shortLiqAlpha)  // Deep purple â€” short liquidation (preserved)

// â”€â”€ Glow simulation (3-layer plots â€” outer/mid/core) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
plot(showPriceLiq ? longLiq  : na, "Long Liq Glow 3",  color=color.new(#ffd700, math.min(longLiqAlpha  + 40, 95)), linewidth=longLiqWidth  + 2, title="Long Liq Outer")
plot(showPriceLiq ? longLiq  : na, "Long Liq Glow 2",  color=color.new(#ffd700, math.min(longLiqAlpha  + 20, 90)), linewidth=longLiqWidth  + 1, title="Long Liq Mid")
plot(showPriceLiq ? longLiq  : na, "Long Liq Core",    color=longLiqColor,                                          linewidth=longLiqWidth,       title="Long Liq")

plot(showPriceLiq ? shortLiq : na, "Short Liq Glow 3", color=color.new(#8b00ff, math.min(shortLiqAlpha + 40, 95)), linewidth=shortLiqWidth + 2, title="Short Liq Outer")
plot(showPriceLiq ? shortLiq : na, "Short Liq Glow 2", color=color.new(#8b00ff, math.min(shortLiqAlpha + 20, 90)), linewidth=shortLiqWidth + 1, title="Short Liq Mid")
plot(showPriceLiq ? shortLiq : na, "Short Liq Core",   color=shortLiqColor,                                         linewidth=shortLiqWidth,      title="Short Liq")

// Swing liq levels (same glow, fixed thickness)
plot(showSwingLiq ? longSwingLiq  : na, "Long Swing Liq",  color=color.new(#ffd700, 50), linewidth=2, style=plot.style_stepline)
plot(showSwingLiq ? shortSwingLiq : na, "Short Swing Liq", color=color.new(#8b00ff, 50), linewidth=2, style=plot.style_stepline)

// â”€â”€ Age labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Show age label at the END of the liq line (rightmost visible bar)
if showNakedAge and barstate.islast
    if not na(longLiq) and longLiqAge > 0
        magnet_str = longLiqAge >= nakedLvl3 ? " ðŸ§²ðŸ§²ðŸ§²" : longLiqAge >= nakedLvl2 ? " ðŸ§²ðŸ§²" : longLiqAge >= nakedLvl1 ? " ðŸ§²" : ""
        label.new(bar_index, longLiq,
             text      = "LONG LIQ  " + str.tostring(longLiqAge) + "b" + magnet_str,
             xloc      = xloc.bar_index,
             yloc      = yloc.price,
             style     = label.style_label_left,
             color     = color.new(#0d0d12, 80),
             textcolor = color.new(#ffd700, longLiqAlpha),
             size      = size.small)

    if not na(shortLiq) and shortLiqAge > 0
        magnet_str = shortLiqAge >= nakedLvl3 ? " ðŸ§²ðŸ§²ðŸ§²" : shortLiqAge >= nakedLvl2 ? " ðŸ§²ðŸ§²" : shortLiqAge >= nakedLvl1 ? " ðŸ§²" : ""
        label.new(bar_index, shortLiq,
             text      = "SHORT LIQ  " + str.tostring(shortLiqAge) + "b" + magnet_str,
             xloc      = xloc.bar_index,
             yloc      = yloc.price,
             style     = label.style_label_left,
             color     = color.new(#0d0d12, 80),
             textcolor = color.new(#8b00ff, shortLiqAlpha),
             size      = size.small)

// Alert: liq level swept (SFP setup â€” this is the entry trigger event)
alertcondition(longLiqSwept  and longLiqAge  >= nakedLvl1, title="Long Liq Swept (SFP)",  message="ðŸŸ¡ Long Liq SWEPT after " + str.tostring(longLiqAge)  + " bars naked â€” SFP setup")
alertcondition(shortLiqSwept and shortLiqAge >= nakedLvl1, title="Short Liq Swept (SFP)", message="ðŸŸ£ Short Liq SWEPT after " + str.tostring(shortLiqAge) + " bars naked â€” SFP setup")


// =============================================================================
// â”€â”€â”€ LIVE STATUS DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// =============================================================================
// Replaces the single-cell "Repainting Mode Enabled" table with a full
// live readout of all key state variables.

var table statusTable = table.new(position.top_right, 2, 6,
     bgcolor      = color.new(#0d0d12, 15),
     border_color = color.new(#1a2040, 100),
     border_width = 1,
     frame_color  = color.new(#1a2040, 100),
     frame_width  = 1)

if barstate.islast
    // Row 0: Regime
    table.cell(statusTable, 0, 0, "REGIME",
         text_color=color.new(#4a5568, 0), text_size=size.tiny, bgcolor=color.new(#0d0d12, 5))
    table.cell(statusTable, 1, 0, regimeStr,
         text_color=regimeColor, text_size=size.tiny, bgcolor=color.new(#0d0d12, 5))

    // Row 1: Z-Score with tier
    zTierLabel = z_bull_3 ? "CAPIT ðŸŸ¢ðŸŸ¢ðŸŸ¢" : z_bull_2h ? "SCALE ðŸŸ¢ðŸŸ¢" : z_bull_2 ? "PRIMARY ðŸŸ¢" : z_pre_bull ? "PRE-ALERT" :
                 z_bear_3 ? "CAPIT ðŸ”´ðŸ”´ðŸ”´"  : z_bear_2h ? "SCALE ðŸ”´ðŸ”´"  : z_bear_2 ? "PRIMARY ðŸ”´"  : z_pre_bear ? "PRE-ALERT" : "NEUTRAL âšª"
    zDisplayColor = z_bull_2 or z_bull_2h or z_bull_3 ? color.new(#39ff14, 0) :
                    z_bear_2 or z_bear_2h or z_bear_3 ? color.new(#ff3131, 0) :
                    z_pre_bull or z_pre_bear ? color.new(#ffc400, 0) : color.new(#4a5568, 0)
    table.cell(statusTable, 0, 1, "Z-SCORE",
         text_color=color.new(#4a5568, 0), text_size=size.tiny, bgcolor=color.new(#0d0d12, 5))
    table.cell(statusTable, 1, 1, str.tostring(zScore, "#.##") + "  " + zTierLabel,
         text_color=zDisplayColor, text_size=size.tiny, bgcolor=color.new(#0d0d12, 5))

    // Row 2: CVD
    cvdLabel = cvd_ltf > 0 ? "ðŸ“ˆ +" + str.tostring(math.round(cvd_ltf)) : "ðŸ“‰ " + str.tostring(math.round(cvd_ltf))
    cvdColor = cvd_ltf > 0 ? color.new(#00aaff, 0) : color.new(#ff8800, 0)
    table.cell(statusTable, 0, 2, "EST. CVD",
         text_color=color.new(#4a5568, 0), text_size=size.tiny, bgcolor=color.new(#0d0d12, 5))
    table.cell(statusTable, 1, 2, cvdLabel,
         text_color=cvdColor, text_size=size.tiny, bgcolor=color.new(#0d0d12, 5))

    // Row 3: OI Flow
    flowLabel = newLongs ? "NEW LONGS" : newShorts ? "NEW SHORTS" : shortsClosing ? "SHORTS CLOSING" : longsClosing ? "LONGS CLOSING" : "CHOP"
    table.cell(statusTable, 0, 3, "OI FLOW",
         text_color=color.new(#4a5568, 0), text_size=size.tiny, bgcolor=color.new(#0d0d12, 5))
    table.cell(statusTable, 1, 3, flowLabel,
         text_color=flowColor, text_size=size.tiny, bgcolor=color.new(#0d0d12, 5))

    // Row 4: Composite Score
    table.cell(statusTable, 0, 4, "SCORE",
         text_color=color.new(#4a5568, 0), text_size=size.tiny, bgcolor=color.new(#0d0d12, 5))
    scoreColor = compositeScore >= compositeThresh ? color.new(#39ff14, 0) : compositeScore <= -compositeThresh ? color.new(#ff00aa, 0) : color.new(#4a5568, 0)
    table.cell(statusTable, 1, 4, str.tostring(compositeScore, "#.#") + " / 5.0",
         text_color=scoreColor, text_size=size.tiny, bgcolor=color.new(#0d0d12, 5))

    // Row 5: Composite Signal
    sigLabel = buyZone ? "â˜… BUY ZONE" : sellZone ? "â˜… SELL ZONE" : repaint ? "âš  REPAINTING" : "â€”"
    sigColor = buyZone ? color.new(#39ff14, 0) : sellZone ? color.new(#ff00aa, 0) : color.new(#4a5568, 0)
    table.cell(statusTable, 0, 5, "SIGNAL",
         text_color=color.new(#4a5568, 0), text_size=size.tiny, bgcolor=color.new(#0d0d12, 5))
    table.cell(statusTable, 1, 5, sigLabel,
         text_color=sigColor, text_size=size.tiny, bgcolor=color.new(#0d0d12, 5))

